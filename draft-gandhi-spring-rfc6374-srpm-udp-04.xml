<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC0768 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.0768.xml">
<!ENTITY RFC2119 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC6374 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6374.xml">
<!ENTITY RFC7876 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7876.xml">
<!ENTITY RFC8174 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY I-D.gandhi-mpls-rfc6374-sr SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-mpls-rfc6374-sr.xml">
<!ENTITY I-D.gandhi-spring-twamp-srpm SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-spring-twamp-srpm.xml">
<!ENTITY RFC2104 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2104.xml">
<!ENTITY RFC4868 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4868.xml">
<!ENTITY RFC6335 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6335.xml">
<!ENTITY RFC8754 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml">
<!ENTITY RFC8762 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8762.xml">
<!ENTITY I-D.ietf-spring-segment-routing-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-segment-routing-policy.xml">
<!ENTITY I-D.voyer-spring-sr-replication-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.voyer-spring-sr-replication-segment.xml">
<!ENTITY I-D.ietf-pce-binding-label-sid SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-binding-label-sid.xml">
<!ENTITY I-D.ietf-spring-mpls-path-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-mpls-path-segment.xml">
<!ENTITY I-D.ietf-spring-srv6-network-programming SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-srv6-network-programming.xml">
<!ENTITY I-D.gandhi-mpls-ioam-sr SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-mpls-ioam-sr.xml">
<!ENTITY I-D.ali-spring-ioam-srv6 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ali-spring-ioam-srv6.xml">
]>
<rfc submissionType="IETF" docName="draft-gandhi-spring-rfc6374-srpm-udp-04" category="std" ipr="trust200902">
	<!-- Generated by id2xml 1.5.0 on 2020-06-08T23:09:27Z -->
	<?rfc compact="yes"?>
	<?rfc text-list-symbols="oo*+-"?>
	<?rfc subcompact="no"?>
	<?rfc sortrefs="no"?>
	<?rfc symrefs="yes"?>
	<?rfc strict="yes"?>
	<?rfc toc="yes"?>
	<front>
	<title abbrev="Using RFC 6374 with UDP Path for SR">Performance Measurement Using RFC 6374 with UDP Path for Segment Routing Networks</title>

	<author fullname="Rakesh Gandhi" initials="R." role="editor" surname="Gandhi">
	<organization>Cisco Systems, Inc.</organization>
	<address><postal><street>Canada</street>
	</postal>
        <email>rgandhi@cisco.com</email>
	</address>
	</author>

	<author fullname="Clarence Filsfils" initials="C." surname="Filsfils">
	<organization>Cisco Systems, Inc.</organization>
        <address>
        <email>cfilsfil@cisco.com</email>
	</address>
	</author>

	<author fullname="Daniel Voyer" initials="D." surname="Voyer">
	<organization>Bell Canada</organization>
        <address>
        <email>daniel.voyer@bell.ca</email>
	</address>
	</author>

	<author fullname="Stefano Salsano" initials="S." surname="Salsano">
	<organization>Universita di Roma "Tor Vergata"</organization>
	<address><postal><street>Italy</street>
	</postal>
	<email>stefano.salsano@uniroma2.it</email>
        </address>
	</author>

	<author fullname="Mach(Guoyi) Chen" initials="M." surname="Chen">
	<organization>Huawei</organization>
        <address>
        <email>mach.chen@huawei.com</email>
	</address>
	</author>

	<date day="11" month="June" year="2020"/>
	<workgroup>SPRING Working Group</workgroup>
	<abstract><t>
   Segment Routing (SR) leverages the source routing paradigm.  Segment
   Routing (SR) is applicable to both Multiprotocol Label Switching
   (SR-MPLS) and IPv6 (SRv6) data planes.  This document specifies
   procedures for using UDP path for sending and processing probe query
   and response messages for Performance Measurement (PM).  The
   procedure uses the mechanisms defined in RFC 6374 for Performance
   Delay and Loss Measurement. The procedure specified is applicable to
   SR-MPLS and SRv6 data planes for both Links and end-to-end
   SR Paths including SR Policies measurements.</t>

	</abstract>
	</front>

	<middle>
	<section title="Introduction" anchor="sect-1"><t>
   Segment Routing (SR) leverages the source routing paradigm and
   greatly simplifies network operations for Software Defined Networks
   (SDNs).  SR is applicable to both Multiprotocol Label Switching
   (SR-MPLS) and IPv6 (SRv6) data planes.  SR takes advantage of the
   Equal-Cost Multipaths (ECMPs) between source and transit nodes,
   between transit nodes and between transit and destination nodes.  SR
   Policies as defined in <xref target="I-D.ietf-spring-segment-routing-policy"/> are used
   to steer traffic through a specific, user-defined paths using a stack
   of Segments.  Built-in SR Performance Measurement (PM) is one of the
   essential requirements to provide Service Level Agreements (SLAs).</t>

	<t>
   <xref target="RFC6374"/> specifies protocol mechanisms to enable the efficient and
   accurate measurement of performance metrics and can be used in SR
   networks with MPLS data plane <xref target="I-D.gandhi-mpls-rfc6374-sr"/>.  <xref target="RFC6374"/>
   addresses the limitations of the IP based performance measurement
   protocols as specified in Section 1 of <xref target="RFC6374"/>.  <xref target="RFC6374"/>
   requires data plane to support MPLS Generic Associated Channel Label
   (GAL) and Generic Associated Channel (G-Ach), which may not be
   supported on all nodes in the segment routing network.</t>

	<t>
   <xref target="RFC7876"/> specifies the procedures to be used when sending and
   processing out-of-band performance measurement probe response
   messages over an UDP return path for RFC 6374 based probe queries.
   <xref target="RFC7876"/> can be used to send out-of-band probe responses in both
   SR-MPLS and SRv6 networks for one-way performance measurement.</t>

	<t>
   For SR Policies, there are ECMPs between the source and transit
   nodes, between transit nodes and between transit and destination
   nodes.  RFC 6374 does not define handling for ECMP forwarding paths
   when used in SR networks.</t>

	<t>
   For two-way measurements for SR Policies, there is a requirement to
   specify a return path in the form of a Segment List in probe query
   messages that does not require on any SR Policy state information on the
   destination node.</t>

	<t>
   This document specifies a procedure for sending and processing probe
   query and response messages using UDP paths for Performance
   Measurement in SR networks.  The procedure uses RFC 6374 defined
   mechanisms for Performance Delay and Loss Measurement and unless
   otherwise specified, the procedures from RFC 6374 are not modified.
   The procedure specified is applicable to both SR-MPLS and SRv6 data
   planes.  The procedure can be used for both Links and end-to-end
   SR Paths including SR Policies measurements.</t>

	</section>

	<section title="Conventions Used in This Document" anchor="sect-2"><section title="Requirements Language" anchor="sect-2.1"><t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC2119"/> <xref target="RFC8174"/>
   when, and only when, they appear in all capitals, as shown here.</t>

	</section>

	<section title="Abbreviations" anchor="sect-2.2"><t>
   ACH: Associated Channel Header.</t>

	<t>
   BSID: Binding Segment ID.</t>

	<t>
   DFLag: Data Format Flag.</t>

	<t>
   DM: Delay Measurement.</t>

	<t>
   ECMP: Equal Cost Multi-Path.</t>

	<t>
   G-ACh: Generic Associated Channel (G-ACh).</t>

	<t>
   GAL: Generic Associated Channel (G-ACh) Label.</t>

	<t>
   LM: Loss Measurement.</t>

	<t>
   MPLS: Multiprotocol Label Switching.</t>

	<t>
   NTP: Network Time Protocol.</t>

	<t>
   PM: Performance Measurement.</t>

	<t>
   PSID: Path Segment Identifier.</t>

	<t>
   PTP: Precision Time Protocol.</t>

	<t>
   SID: Segment ID.</t>

	<t>
   SL: Segment List.</t>

	<t>
   SR: Segment Routing.</t>

	<t>
   SRH: Segment Routing Header.</t>

	<t>
   SR-MPLS: Segment Routing with MPLS data plane.</t>

	<t>
   SRv6: Segment Routing with IPv6 data plane.</t>

	<t>
   TC: Traffic Class.</t>

	<t>
   URO: UDP Return Object.</t>

	</section>

	<section title="Reference Topology" anchor="sect-2.3"><t>
   In the reference topology shown below, the querier node R1 initiates a
   probe query for performance measurement and the responder node R5
   sends a probe response for the probe query message received.  The probe
   response may be sent to the querier node R1 or to a controller node
   R100.  The nodes R1 and R5 may be directly connected via a Link
   enabled with Segment Routing or there exists a Point-to-Point (P2P)
   SR Path e.g. SR Policy <xref target="I-D.ietf-spring-segment-routing-policy"/> on node R1 with
   destination to node R5.  In case of Point-to-Multipoint (P2MP), SR
   Policy originating from source node R1 may terminate on multiple
   destination leaf nodes <xref target="I-D.voyer-spring-sr-replication-segment"/>.</t>

	<figure><artwork><![CDATA[
                                          ------
                                          |R100|
                                          ------
                                            ^
                                            | Response
                                            |
          +-------+       Query         +-------+
          |       | - - - - - - - - - ->|       |
          |   R1  |=====================|   R5  |
          |       |<- - - - - - - - - - |       |
          +-------+       Response      +-------+
           Querier                      Responder

                    Reference Topology
]]></artwork>
	</figure>
	</section>

	</section>

	<section title="Overview" anchor="sect-3"><t>
   One-way delay, two-way and round-trip delay measurement procedures defined in
   Section 2.4 of <xref target="RFC6374"/> are used.  For transmit and Receive packet
   loss, the measurement procedures defined in <xref target="sect-2.2"/> and Section
   2.6 of <xref target="RFC6374"/> are used.  Separate UDP destination port numbers are
   user-configured for delay and loss measurements from the range
   specified in <xref target="RFC8762"/>.  The querier node uses the destination UDP
   port number following the guidelines specified in <xref target="sect-6"/> in
   <xref target="RFC6335"/>.  For both Links and end-to-end SR Policies, no PM session
   for delay or loss measurement is created on the responder node R5
   <xref target="RFC6374"/>.</t>

	<t>
   For Performance Measurement, probe query and response messages are
   sent as following:</t>

	<t><list style="symbols"><t>For Delay Measurement, the probe messages are sent on the
      congruent path of the data traffic by the querier node, and are
      used to measure the delay experienced by the actual data traffic
      flowing on the Links and SR Policies.</t>

	<t>For Loss Measurement, the probe messages are sent on the congruent
      path of the data traffic by the querier node, and are used to
      collect the receive traffic counters for the incoming link or
      incoming SID where the probe query messages are received at the
      responder node (incoming link or incoming SID needed since the
      responder node does not have PM session state present).</t>

	</list>
	</t>

	<t>
   The In-Situ Operations, Administration, and Maintenance (IOAM)
   mechanisms for SR-MPLS defined in <xref target="I-D.gandhi-mpls-ioam-sr"/> and for SRv6
   defined in <xref target=" I-D.ali-spring-ioam-srv6"/> are used to carry PM information
   such as timestamp in-band as part of the data packets, and are
   outside the scope of this document.</t>

	<section title="Example Provisioning Model" anchor="sect-3.1"><t>
   An example provisioning model described in <xref target="I-D.gandhi-spring-twamp-srpm"/> is
   also applicable to the procedures defined in this document.</t>

	</section>

	</section>

	<section title="Probe Query Message" anchor="sect-4"><t>
   In this document, UDP path is used for Delay and Loss measurements
   for Links and end-to-end SR Policies for the probe messages
   defined in <xref target="RFC6374"/>.  The user-configured destination UDP ports
   (separate UDP ports for different delay and loss message formats) are
   used for identifying the probe packets.</t>

	<section title="Delay Measurement Probe Query Message" anchor="sect-4.1"><t>
   The message content for Delay Measurement for probe query message
   using UDP header <xref target="RFC0768"/> is shown in Figure 1.  The DM probe query
   message is sent with user-configured Destination UDP port number for
   DM.  The Destination UDP port can also be used as Source port for
   two-way delay measurement, since the message has a flag to
   distinguish between query and response.  The DM probe query message
   contains the payload format for delay measurement defined in Section
   3.2 of <xref target="RFC6374"/>.</t>

	<figure title="DM Probe Query Message" anchor="ure-dm-probe-query-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Querier IPv4 or IPv6 Address             .
 .  Destination IP Address = Responder IPv4 or IPv6 Address      .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Querier                           .
 .  Destination Port = User-configured Port for Delay Measurement.
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Message as specified in Section 3.2 of RFC 6374     |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   It is recommended to use the IEEE 1588v2 Precision Time Protocol
   (PTP) truncated 64-bit timestamp format as a default
   format as specified in Appendix A of <xref target="RFC6374"/>, with
   hardware support.  As an alternative, Network Time Protocol (NTP)
   timestamp format can also be used <xref target="RFC6374"/>.</t>

	</section>

	<section title="Loss Measurement Probe Query Message" anchor="sect-4.2"><t>
   The message content for Loss measurement probe query message using
   UDP header [RFC768] is shown in Figure 2.  As shown, the LM probe
   query message is sent with user-configured Destination UDP port
   number for LM.  Separate Destination UDP ports are used for
   direct-mode and inferred-mode loss measurements.  The Destination UDP
   port can also be used as Source port for two-way loss measurement,
   since the message has a flag to distinguish between query and
   response.  The LM probe query message contains the payload format for
   loss measurement defined in Section 3.1 of <xref target="RFC6374"/>.</t>

	<figure title="LM Probe Query Message" anchor="ure-lm-probe-query-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Querier IPv4 or IPv6 Address             .
 .  Destination IP Address = Responder IPv4 or IPv6 Address      .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Querier                           .
 .  Destination Port = User-configured Port for Loss Measurement .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Message as specified in Section 3.1 of RFC 6374     |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	</section>

	<section title="Combined Loss/Delay Measurement Probe Query Message" anchor="sect-4.3"><t>
   The message content for combined Loss/Delay measurement probe query message using
   UDP header [RFC768] is shown in Figure 3.  As shown, the probe
   query message is sent with user-configured Destination UDP port
   number for combined LM/DM message format.  Separate Destination UDP ports are used for
   direct-mode and inferred-mode loss measurements.  The Destination UDP
   port can also be used as Source port for two-way loss/delay measurement,
   since the message has a flag to distinguish between query and
   response.  The probe query message contains the payload format for
   combined loss/delay measurement defined in Section 3.3 of <xref target="RFC6374"/>.</t>

	<figure title="LM/DM Probe Query Message" anchor="ure-lm-dm-probe-query-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Querier IPv4 or IPv6 Address             .
 .  Destination IP Address = Responder IPv4 or IPv6 Address      .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Querier                           .
 .  Destination Port = User-configured Port for                  . 
 .                     Loss/Delay Measurement                    .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Message as specified in Section 3.3 of RFC 6374     |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	</section>


   <section title="Probe Query Message for Links" anchor="sect-4.4"><t>
   The probe query message as defined in Figure 1 is sent on the
   congruent path of the data traffic for performance Delay measurement.
   Similarly, the probe query message as defined in Figure 2 is sent on
   the congruent path of the data traffic for performance Loss measurement.
	</t>

	</section>

	<section title="Probe Query Message for SR Policies" anchor="sect-4.5"><t>
   The performance delay and loss measurement for segment routing is
   applicable to both SR-MPLS and SRv6 Policies.</t>

	<section title="Probe Query Message for SR-MPLS Policy" anchor="sect-4.5.1"><t>
   The probe query message for end-to-end 
   SR-MPLS Policy performance measurement is sent using its SR-MPLS header containing the MPLS
   segment list as shown in Figure 4.</t>

	<figure title="Example Probe Query Message for SR-MPLS Policy" anchor="ure-probe-query-message-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                PSID                   | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Payload = DM Message as specified in Figure 1                 |
 . Payload = LM Message as specified in Figure 2                 .
 . Payload = LM/DM Message as specified in Figure 3              .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Segment List (SL) can be empty to indicate Implicit NULL label
   case for a single-hop SR Policy.</t>

	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the SR-MPLS Policy is used for accounting received traffic on the
   egress node for loss measurement.</t>

	</section>

	<section title="Probe Query Message for SRv6 Policy" anchor="sect-4.5.2"><t>
   An SRv6 Policy setup using the SRv6 Segment Routing Header (SRH)
   and a Segment List is defined in <xref target="RFC8754"/>.
   For SRv6, network programming is defined in 
   <xref target="I-D.ietf-spring-srv6-network-programming"/>. 
   The probe query messages using UDP header for end-to-end 
   SRv6 Policy performance measurement is sent using its SRv6 Segment Routing
   Header (SRH) and Segment List as shown in Figure 5.</t>

	<figure title="Example Probe Query Message for SRv6 Policy" anchor="ure-probe-query-message-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Querier IPv6 Address                     .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Querier IPv6 Address                     .
 .  Destination IP Address = Responder IPv6 Address              .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Querier                           .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Figure 1                 |
 . Payload = LM Message as specified in Figure 2                 .
 . Payload = LM/DM Message as specified in Figure 3              .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	</section>

	</section>

	</section>

	<section title="Probe Response Message" anchor="sect-5"><t>
   When the received probe query message does not contain any UDP Return
   Object (URO) TLV <xref target="RFC7876"/>, the probe response message is sent using
   the IP/UDP information from the received probe query message.  The
   content of the probe response message is shown in Figure 6.</t>

	<figure title="Probe Response Message" anchor="ure-probe-response-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Responder IPv4 or IPv6 Address           .
 .  Destination IP Address = Source IP Address from Query        .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Responder                         .
 .  Destination Port = Source Port from Query                    .
 .                                                               .
 +---------------------------------------------------------------+
 | Message as specified in Section 3.2 of RFC 6374 for DM, or    |
 . Message as specified in Section 3.1 of RFC 6374 for LM, or    .
 . Message as specified in Section 3.3 of RFC 6374 for LM/DM     .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   When the received probe query message contains UDP Return Object
   (URO) TLV <xref target="RFC7876"/>, the probe response message uses the IP/UDP
   information from the URO in the probe query message.  The content of
   the probe response message is shown in Figure 7.</t>

	<figure title="Probe Response Message Using URO from Probe Query" anchor="ure-probe-response-message-using-uro-from-probe-query"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Responder IPv4 or IPv6 Address           .
 .  Destination IP Address = URO.Address                         .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Responder                         .
 .  Destination Port = URO.UDP-Destination-Port                  .
 .                                                               .
 +---------------------------------------------------------------+
 | Message as specified in Section 3.2 of RFC 6374 for DM, or    |
 . Message as specified in Section 3.1 of RFC 6374 for LM, or    .
 . Message as specified in Section 3.3 of RFC 6374 for LM/DM     .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<section title="One-way Measurement Mode" anchor="sect-5.1"><section title="Links and SR Policies" anchor="sect-5.1.1"><t>
   In one-way performance measurement mode, the probe response message
   as defined in Figure 6 or Figure 7 is sent out-of-band to the querier
   node, for both Links and SR Policies.</t>

	<t>
   The querier node can receive probe response message back by setting
   its own IP address as Source Address of the header or by adding URO
   TLV in the probe query message and setting its own IP address in the
   IP Address in the URO TLV (Type=131) <xref target="RFC7876"/>.  The "control code"
   in the probe query message is set to "out-of-band response requested".  
   The "Source Address" TLV (Type 130), and "Return Address" TLV (Type 1), if present in the probe query message, are not
   used to send probe response message.</t>

	</section>

	<section title="Probe Response Message to Controller" anchor="sect-5.1.2"><t>
   As shown in the Reference Topology, if the querier node requires the
   probe response message to be sent to the controller R100, it adds URO
   TLV in the probe query message and sets the IP address of R100 in the
   IP Address field and user-configured UDP port for DM and for LM in
   the UDP-Destination-Port field of the URO TLV (Type=131) <xref target="RFC7876"/>.</t>

	</section>

	</section>

	<section title="Two-way Measurement Mode" anchor="sect-5.2"><section title="Links" anchor="sect-5.2.1"><t>
   In two-way performance measurement mode, when using a bidirectional
   link, the probe response message as defined in Figure 6 or Figure 7
   is sent back on the congruent path of the data traffic to the querier
   node for Links.  In this case, the "control code" in the probe
   query message is set to "in-band response requested" <xref target="RFC6374"/>.</t>

	</section>

	<section title="SR Policies" anchor="sect-5.2.2"><t>
   In two-way performance measurement mode, when using a bidirectional
   path, the probe response message is sent back on the congruent path
   of the data traffic to the querier node for end-to-end 
   SR Policies measurements.  In this case, the "control code" in the probe query
   message is set to "in-band response requested" <xref target="RFC6374"/>.</t>

	</section>

	<section title="Return Path TLV" anchor="sect-5.2.3"><t>
   For two-way performance measurement, the querier node can request the
   responder node to send a response message back on a given reverse
   path (e.g. co-routed path for two-way measurement).  Return Path TLV
   defined in <xref target="I-D.gandhi-mpls-rfc6374-sr"/> is used to carry reverse SR path
   information as part of the payload of the probe query message.</t>

	<t>
   Additional Sub-TLVs are defined in this document for the
   Return Path TLV for the following Types:</t>

	<t><list style="symbols"><t>Type (value TBA1): SRv6 Segment List of the Reverse SR Path</t>

	<t>Type (value TBA2): SRv6 Binding SID <xref target="I-D.ietf-pce-binding-label-sid"/> of
      the Reverse SR Policy</t>

	</list>
	</t>

	</section>

	<section title="Probe Response Message for SR-MPLS Policy" anchor="sect-5.2.4"><t>
   The message content for sending probe response message on the
   congruent path of the data traffic for two-way end-to-end 
   SR-MPLS Policy performance measurement is shown in Figure 8.  The SR-MPLS
   label stack in the packet header is built using the Segment List
   received in the Return Path TLV in the probe query message.</t>

	<figure title="Example Probe Response Message for SR-MPLS Policy" anchor="ure-probe-response-message-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Message as shown in Figure 6 or Figure 7       |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the forward SR-MPLS Policy can be used to find the reverse SR-MPLS
   Policy to send the probe response message for two-way measurement in
   the absence of Return Path TLV.</t>

	</section>

	<section title="Probe Response Message for SRv6 Policy" anchor="sect-5.2.5"><t>
   The message content for sending probe response message on the
   congruent path of the data traffic for two-way end-to-end 
   SRv6 Policy performance measurement is shown in Figure 9.  For SRv6 Policy
   using SRH, the SRv6 SID list in the SRH of the probe response message
   is built using the SRv6 Segment List received in the Return Path TLV
   in the probe query message.</t>

	<figure title="Example Probe Response Message for SRv6 Policy" anchor="ure-probe-response-message-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Responder IPv6 Address                   .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Responder IPv6 Address                   .
 .  Destination IP Address = Querier IPv6 Address                .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Responder                         .
 .  Destination Port = Source Port from Query                    .
 .                                                               .
 +---------------------------------------------------------------+
 | Message as specified in Section 3.2 of RFC 6374 for DM, or    |
 . Message as specified in Section 3.1 of RFC 6374 for LM, or    .
 . Message as specified in Section 3.3 of RFC 6374 for LM/DM     .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	</section>

	</section>

	<section title="Loopback Measurement Mode" anchor="sect-5.3"><t>
   The Loopback measurement mode defined in Section 2.8 of <xref target="RFC6374"/> can
   be used to measure round-trip delay of a bidirectional SR Path.  The
   IP header of the probe query message contains the destination address
   equals to the querier node address and the source address equals to the
   responder address.  Optionally, the probe query message can carry the
   reverse path information (e.g. reverse path label stack for SR-MPLS)
   as part of the SR header.  The responder node does not process the 
   probe messages and generate response messages, and hence 
   Loopback Request object (Type 3) is not required for SR.</t>

	</section>

	</section>

	<section title="Performance Measurement for P2MP SR Policies" anchor="sect-6"><t>
   For P2MP SR Policies <xref target="I-D.voyer-spring-sr-replication-segment"/>, the
   procedure defined in <xref target="I-D.gandhi-spring-twamp-srpm"/> is also
   applicable to the procedures defined in this document (using the RFC 6374 messages in the payload).</t>

	</section>

	<section title="ECMP Support for SR Policies" anchor="sect-7"><t>
   For handling ECMP of SR Policies, the procedure defined in
   <xref target="I-D.gandhi-spring-twamp-srpm"/> is also applicable to the procedure
   defined in this document.</t>

	</section>

	<section title="Additional Probe Message Processing Rules" anchor="sect-8"><t>
   The additional probe message processing rules defined in
   <xref target="I-D.gandhi-spring-twamp-srpm"/> are also applicable to the procedures defined
   in this document.</t>

	</section>

	<section title="Sequence Numbers" anchor="sect-9"><t>
   The message formats for DM and LM <xref target="RFC6374"/> can carry either
   timestamp or sequence number but not both.  There are case where both
   timestamp and sequence number are desired for both DM and LM.
   Sequence numbers can be useful when some probe query messages are
   lost or they arrive out of order.  In addition, the sequence numbers
   can be useful for detecting denial-of-service (DoS) attacks on UDP
   ports.</t>

	<section title="Sequence Number TLV in Unauthenticated Mode" anchor="sect-9.1"><t>
   <xref target="RFC6374"/> defines DM and LM probe query and response messages that
   can include one or more optional TLVs.  New TLV Type (value TBA3) is
   defined in this document to carry sequence number for probe query and
   response messages for delay and loss measurement.  The format of the
   Sequence Number TLV in unauthenticated mode is shown in Figure 10.</t>

	<figure title="Sequence Number TLV - Unauthenticated Mode" anchor="ure-sequence-number-tlv-unauthenticated-mode"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Type TBA3   |    Length     |      Reserved                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Sequence Number                            |
 ~                                                               ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>
	<t><list style="symbols"><t>The sequence numbers start with 0 and are incremented by one for
      each subsequent probe query packet.</t>

	<t>The sequence number are independent for DM and LM messages.</t>

	<t>The sequence number can be of any length determined by the querier
      node.</t>

	<t>The Sequence Number TLV is optional.</t>

	<t>The querier node SHOULD only insert one Sequence Number TLV in
      the probe query message and the responder node in the probe
      response message SHOULD return the first Sequence Number TLV from
      the probe query message and ignore the other Sequence Number TLVs
      if present.</t>

	<t>When Sequence Number TLV is added, the DM and LM messages SHOULD
      NOT carry sequence number in the timestamp field of the message.</t>

	</list>
	</t>

	</section>

	<section title="Sequence Number TLV in Authenticated Mode" anchor="sect-9.2"><t>
   The probe query and response packet format in authenticated mode
   includes a key Hashed Message Authentication Code (HMAC) (<xref target="RFC2104"/>)
   hash.  Each probe query and response messages are authenticated by
   adding Sequence Number with Hashed Message Authentication Code (HMAC)
   TLV.  It can use HMAC-SHA-256 truncated to 128 bits (similarly to the
   use of it in IPSec defined in <xref target="RFC4868"/>); hence the length of the
   HMAC field is 16 octets.</t>

	<t>
   In authenticated mode, only the sequence number is encrypted, and the
   other payload fields are sent in clear text.  The probe packet MAY
   include Comp.MBZ (Must Be Zero) variable length field to align the
   packet on 16 octets boundary.</t>

	<t>
   The computation of HMAC field using HMAC-SHA1 can be used with the
   procedure defined in this document.  HMAC uses own key and the
   definition of the mechanism to distribute the HMAC key is outside the
   scope of this document.  Both the authentication type and key can be
   user-configured on both the querier and responder nodes.</t>

	<t>
   The format of the Sequence Number TLV in authentication mode is shown
   in Figure 11.</t>

	<figure title="Sequence Number TLV - Authenticated Mode" anchor="ure-sequence-number-tlv-authenticated-mode"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Type TBA4   |    Length     |      Reserved                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Sequence Number                            |
 ~                                                               ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                    Comp.MBZ                                   ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    HMAC (16 octets)                           |
 |                                                               |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>
	<t><list style="symbols"><t>This TLV is mandatory in the authenticated mode.</t>

	<t>The node MUST discard the probe message if HMAC is invalid.</t>

	<t>The Sequence Number follows the same processing rule as defined in
      the unauthenticated mode.</t>

	</list>
	</t>

	</section>

	</section>

    <section title="Performance Delay and Liveness Monitoring" anchor="sect-10"><t>
    The procedure defined in this document for delay measurement  
    can also be applied to liveness monitoring of Links and SR Paths. 
    Liveness failure is notified when consecutive N number of probe response messages are
    not received back at the querier node, where N is locally provisioned value. 
    Note that for one-way and two-way modes, the detection interval 
    and scale for number of sessions need to account for 
    the processing of the probe messages which are punted out of fast path in forwarding 
    (to slow path or control plane), and re-injected on the responder node.</t>
    </section>


	<section title="Security Considerations" anchor="sect-11"><t>
   The performance measurement is intended for deployment in
   well-managed private and service provider networks.  As such, it
   assumes that a node involved in a measurement operation has
   previously verified the integrity of the path and the identity of the
   far end responder node.  The security considerations described in
   Section 8 of <xref target="RFC6374"/> are applicable to this specification, and
   particular attention should be paid to the last three paragraphs.</t>

	<t>
   If desired, attacks can be mitigated by performing basic validation
   and sanity checks, at the querier node, of the counter or timestamp fields
   in received measurement response messages.  The minimal state
   associated with these protocols also limits the extent of measurement
   disruption that can be caused by a corrupt or invalid message to a
   single query/response cycle.</t>

      <t>
   Use of HMAC-SHA-256 in the authenticated mode defined in this
   document protects the data integrity of the probe messages.  SRv6 has
   HMAC protection authentication defined for SRH <xref target="RFC8754"/>.
   Hence, probe messages for SRv6
   may not need authentication mode.  Cryptographic measures may be
   enhanced by the correct configuration of access-control lists and
   firewalls.</t>
	</section>

	<section title="IANA Considerations" anchor="sect-12"><t>
   IANA is requested to allocate the values for the following Sub-TLV
   Types for the Return Path TLV for RFC 6374 from the sub-registry "Return Path Sub-TLV Type" 
   of the "MPLS Loss/Delay Measurement TLV Object" registry 
   contained within the "Generic Associated Channel (G-ACh) Parameters" registry set:</t>

	<t><list style="symbols"><t>Type TBA1: SRv6 Segment List of the Reverse SR Path</t>

	<t>Type TBA2: SRv6 Binding SID of the Reverse SR Policy</t>

	</list>
	</t>

	<t>
   IANA is also requested to allocate the values for the following
   Sequence Number TLV Types for RFC 6374 to be carried in the probe
   query and response messages for delay and loss measurement from the "MPLS Loss/Delay Measurement TLV Object" registry 
   contained within the "Generic Associated Channel (G-ACh) Parameters" registry set:</t>

	<t><list style="symbols"><t>Type TBA3: Sequence Number TLV in Unauthenticated Mode</t>

	<t>Type TBA4: Sequence Number TLV in Authenticated Mode</t>

	</list>
	</t>

	</section>

	</middle>

	<back>
	<references title="Normative References">
	&RFC0768;
	&RFC2119;
	&RFC6374;
	&RFC7876;
	&RFC8174;
	&I-D.gandhi-mpls-rfc6374-sr;
	&I-D.gandhi-spring-twamp-srpm;
	</references>

	<references title="Informative References">
	&RFC2104;
	&RFC4868;
	&RFC6335;
	&RFC8754;
	&RFC8762;
	&I-D.ietf-spring-segment-routing-policy;
	&I-D.voyer-spring-sr-replication-segment;
	&I-D.ietf-pce-binding-label-sid;
	&I-D.ietf-spring-srv6-network-programming;
	&I-D.ietf-spring-mpls-path-segment;
	&I-D.gandhi-mpls-ioam-sr;
	&I-D.ali-spring-ioam-srv6;
	</references>

	<section title="Acknowledgments" numbered="no" anchor="acknowledgments"><t>
   The authors would like to thank Patrick Khordoc for the discussions on RFC 6374;
   Nagendra Kumar and Carlos Pignataro
   for the discussion on SRv6 Performance Measurement.  The authors
   would like to thank Thierry Couture for the discussions on the
   use-cases for the performance measurement in segment routing
   networks.  The authors would also like to thank Stewart Bryant for
   the discussion on UDP port allocation for Performance Measurement and
   Greg Mirsky for providing useful comments and suggestions.</t>

	</section>

	<section title="Contributors" numbered="no" anchor="contributors"><figure><artwork><![CDATA[
Sagar Soni
Cisco Systems, Inc.
Email: sagsoni@cisco.com

Zafar Ali
Cisco Systems, Inc.
Email: zali@cisco.com

Pier Luigi Ventre
CNIT
Italy
Email: pierluigi.ventre@cnit.it
]]></artwork>
	</figure>
	</section>

	</back>

	</rfc>
	
