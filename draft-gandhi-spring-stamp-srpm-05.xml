<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC0768 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.0768.xml">
<!ENTITY RFC2119 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC8174 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY RFC8762 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8762.xml">
<!ENTITY RFC8972 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8972.xml">
<!ENTITY RFC2104 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2104.xml">
<!ENTITY RFC2113 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2113.xml">
<!ENTITY RFC4868 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4868.xml">
<!ENTITY RFC5884 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.5884.xml">
<!ENTITY RFC6335 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6335.xml">
<!ENTITY RFC6437 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6437.xml">
<!ENTITY RFC6936 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6936.xml">
<!ENTITY RFC7820 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7820.xml">
<!ENTITY RFC8029 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8029.xml">
<!ENTITY RFC8085 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8085.xml">
<!ENTITY RFC8126 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8126.xml">
<!ENTITY RFC8186 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8186.xml">
<!ENTITY RFC8321 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8321.xml">
<!ENTITY RFC8402 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml">
<!ENTITY RFC8754 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml">
<!ENTITY I-D.ietf-spring-segment-routing-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-segment-routing-policy.xml">
<!ENTITY I-D.ietf-spring-sr-replication-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-sr-replication-segment.xml">
<!ENTITY I-D.ietf-pim-sr-p2mp-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pim-sr-p2mp-policy.xml">
<!ENTITY I-D.shen-spring-p2mp-transport-chain SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.shen-spring-p2mp-transport-chain.xml">
<!ENTITY I-D.ietf-spring-mpls-path-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-mpls-path-segment.xml">
<!ENTITY I-D.ietf-spring-srv6-network-programming SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-srv6-network-programming.xml">
<!ENTITY I-D.ietf-pce-binding-label-sid SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-binding-label-sid.xml">
<!ENTITY I-D.gandhi-mpls-ioam-sr SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-mpls-ioam-sr.xml">
<!ENTITY I-D.ietf-ippm-stamp-yang SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-ippm-stamp-yang.xml">
<!ENTITY I-D.ali-spring-ioam-srv6 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ali-spring-ioam-srv6.xml">
<!ENTITY I-D.ietf-pce-sr-bidir-path SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-sr-bidir-path.xml">
<!ENTITY I-D.gandhi-spring-sr-enhanced-plm SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-spring-sr-enhanced-plm.xml">
<!ENTITY I-D.gandhi-ippm-stamp-srpm SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-ippm-stamp-srpm.xml">
]>
<rfc submissionType="IETF" docName="draft-gandhi-spring-stamp-srpm-05" category="std" ipr="trust200902">
    <!-- Generated by id2xml 1.5.0 on 2020-02-06T01:41:26Z -->
    <?rfc compact="yes"?>
    <?rfc text-list-symbols="oo*+-"?>
    <?rfc subcompact="no"?>
    <?rfc sortrefs="no"?>
    <?rfc symrefs="yes"?>
    <?rfc strict="yes"?>
    <?rfc toc="yes"?>
    <front>
    <title abbrev="Using STAMP for Segment Routing">Performance Measurement Using Simple TWAMP (STAMP) for Segment Routing Networks</title>
    <author fullname="Rakesh Gandhi" initials="R." role="editor" surname="Gandhi">
    <organization>Cisco Systems, Inc.</organization>
    <address><postal><street>Canada</street>
    </postal>
        <email>rgandhi@cisco.com</email>
    </address>
    </author>

    <author fullname="Clarence Filsfils" initials="C." surname="Filsfils">
    <organization>Cisco Systems, Inc.</organization>
        <address>
        <email>cfilsfil@cisco.com</email>
    </address>
    </author>

    <author fullname="Daniel Voyer" initials="D." surname="Voyer">
    <organization>Bell Canada</organization>
        <address>
        <email>daniel.voyer@bell.ca</email>
    </address>
    </author>

    <author fullname="Mach(Guoyi) Chen" initials="M." surname="Chen">
    <organization>Huawei</organization>
        <address>
        <email>mach.chen@huawei.com</email>
    </address>
    </author>

    <author fullname="Bart Janssens" initials="B." surname="Janssens">
    <organization>Colt</organization>
        <address>
    <email>Bart.Janssens@colt.net</email>
    </address>
    </author>

    <date day="26" month="January" year="2021"/>
    <workgroup>SPRING Working Group</workgroup>
    <abstract><t>
   Segment Routing (SR) leverages the source routing paradigm.  SR is
   applicable to both Multiprotocol Label Switching (SR-MPLS) and IPv6
   (SRv6) data planes.  This document describes procedures  
   for Performance Measurement (PM) in SR networks using the 
   mechanisms defined in RFC 8762 (Simple Two-Way Active Measurement Protocol (STAMP))
   and its optional extensions defined in RFC 8972 and draft-gandhi-ippm-stamp-srpm.
   The procedure described is applicable
   to SR-MPLS and SRv6 data planes and is used for both links and
   end-to-end SR paths including SR Policies.</t>
    </abstract>
    </front>

    <middle>
    <section title="Introduction" anchor="sect-1"><t>
   Segment Routing (SR) leverages the source routing paradigm and
   greatly simplifies network operations for Software Defined Networks
   (SDNs).  SR is applicable to both Multiprotocol Label Switching
   (SR-MPLS) and IPv6 (SRv6) data planes.  SR takes advantage of the
   Equal-Cost Multipaths (ECMPs) between source and transit nodes,
   between transit nodes and between transit and destination nodes.  SR
   Policies as defined in <xref target="I-D.ietf-spring-segment-routing-policy"/> are used
   to steer traffic through a specific, user-defined paths using a stack
   of Segments.  Built-in SR Performance Measurement (PM) is one of the
   essential requirements to provide Service Level Agreements (SLAs).</t>

   <t>The Simple Two-way Active Measurement Protocol (STAMP) provides
   capabilities for the measurement of various performance
   metrics in IP networks using test packets <xref target="RFC8762"/>. 
   It eliminates the need for control protocol by using
   configuration data model to provision test sessions. 
   <xref target="RFC8972"/> defines optional extensions for STAMP.</t>

   <t>This document describes procedures  
   for Performance Measurement (PM) in SR networks using the 
   mechanisms defined in STAMP <xref target="RFC8762"/> 
   and its optional extensions defined in <xref target="RFC8972"/> and <xref target="I-D.gandhi-ippm-stamp-srpm"/>. 
   The procedure described is applicable to SR-MPLS and SRv6 data planes and
   is used for both links and end-to-end SR paths including SR Policies and Flex-Algo IGP Paths.  
   Unless otherwise specified, the mechanisms 
   defined in <xref target="RFC8762"/> and <xref target="RFC8972"/>
   are not modified by this document.</t>
   </section>

   <section title="Conventions Used in This Document" anchor="sect-2"><section title="Requirements Language" anchor="sect-2.1"><t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC2119"/> <xref target="RFC8174"/>
   when, and only when, they appear in all capitals, as shown here.</t>

   </section>

   <section title="Abbreviations" anchor="sect-2.2"><t>
   BSID: Binding Segment ID.</t>

    <t>
   DM: Delay Measurement.</t>

    <t>
   ECMP: Equal Cost Multi-Path.</t>

    <t>
   HMAC: Hashed Message Authentication Code.</t>

    <t>
   MPLS: Multiprotocol Label Switching.</t>

    <t>
   NTP: Network Time Protocol.</t>

    <t>
   OWAMP: One-Way Active Measurement Protocol.</t>

    <t>
   PM: Performance Measurement.</t>

    <t>
   PSID: Path Segment Identifier.</t>

    <t>
   PTP: Precision Time Protocol.</t>

    <t>
   SHA: Secure Hash Algorithm.</t>

    <t>
   SID: Segment ID.</t>

    <t>
   SL: Segment List.</t>

    <t>
   SR: Segment Routing.</t>

    <t>
   SRH: Segment Routing Header.</t>

    <t>
   SR-MPLS: Segment Routing with MPLS data plane.</t>

    <t>
   SRv6: Segment Routing with IPv6 data plane.</t>

    <t>
   SSID: STAMP Session Identifier.</t>

    <t>
   STAMP: Simple Two-way Active Measurement Protocol.</t>

    <t>
   TC: Traffic Class.</t>

   </section>

   <section title="Reference Topology" anchor="sect-2.3"><t>
   In the reference topology shown below, the session-sender R1 initiates a
   STAMP test packet and the session-reflector R3
   sends a reply test packet.  The reply test packet is sent back to the session-sender R1 
   on the same path in the reverse direction or a different path.</t>  

   <t>SR is enabled on nodes R1 and R3. The nodes R1 and R3 may be
   directly connected via a link or there
   exists a Point-to-Point (P2P) SR path e.g. SR Policy
   <xref target="I-D.ietf-spring-segment-routing-policy"/> on node R1 (called head-end)
   with destination to node R3 (called tail-end).</t>

   <figure><artwork><![CDATA[
                       T1                T2
                      /                   \
             +-------+     Test Packet     +-------+
             |       | - - - - - - - - - ->|       |
             |   R1  |=====================|   R3  |
             |       |<- - - - - - - - - - |       |
             +-------+  Reply Test Packet  +-------+
                      \                   /
                       T4                T3

           Session-Sender              Session-Reflector

                       Reference Topology
]]></artwork>
    </figure>
    </section>

   </section>

   <section title="Overview" anchor="sect-3"><t>
   For delay measurement in segment routing networks, in this document,
   the STAMP test packets defined in <xref target="RFC8762"/> are used.</t> 
   
   <t>A destination UDP port number is selected as described in
   <xref target="RFC8762"/>. The same destination UDP 
   port is used for links and end-to-end SR paths and the session-reflector is 
   unaware if the received STAMP test packet is for the links or end-to-end SR paths.</t>

   <t>For delay measurement, STAMP test packets are sent on the
   same path (in-band) as the customer data traffic by the session-sender as are
   used to measure the delay experienced by the customer data traffic
   flowing on the links and end-to-end SR paths.</t>

    <section title="Example Provisioning Model" anchor="sect-3.1"><t>
   An example of a provisioning model and typical measurement parameters for a 
   user-configured destination UDP port 
   for delay measurement is shown in the following Figure 1:</t>

   <figure title="Example Provisioning Model" anchor="ure-example-provisioning-model"><artwork><![CDATA[

                           +------------+
                           | Controller |
                           +------------+
                               /    \
  Destination UDP Port        /      \    Destination UDP port
  Authentication Mode & Key  /        \   Authentication Mode & Key
  Delay Measurement Mode    /          \  Synthetic Loss Type`
      Timestamp Format     /            \    
  Synthetic Loss Type     /              \
                         /                \
                        v                  v
                    +-------+            +-------+
                    |       |            |       |
                    |   R1  |============|   R3  |
                    |       |  SR path   |       |
                    +-------+  Or link   +-------+

                  Session-Sender      Session-Reflector
]]></artwork>
    </figure>

    <t>Example of the Timestamp Format is PTPv2 <xref target="IEEE1588"/> or NTP. 
    Example of synthetic loss type is stateful and stateless <xref target="RFC8762"/>.</t>

    <t>The YANG data model defined in <xref target="I-D.ietf-ippm-stamp-yang"/>
    can be used to provision the STAMP session-sender and session-reflector. 
    The provisioning model is not meant for signaling the PM parameters between the 
    session-sender and session-reflector in SR networks.</t>

    <t>The session-reflector R3 uses the parameters for the timestamp format and
    delay measurement mode (e.g. one-way delay or two-way delay mode)
    from the received STAMP test packet.</t>
    </section>

    </section>

   <section title="Delay Measurement for Links and SR Paths" anchor="sect-4">
   <section title="Session-Sender Test Packet" anchor="sect-4.1"><t>
   The STAMP test packets defined in <xref target="RFC8762"/> are used
   for delay measurement for links and end-to-end SR paths including SR 
   Policies. The packet content for STAMP test packet using
   UDP header <xref target="RFC0768"/> is shown in Figure 2. 
   The payload contains the session-sender test packet defined in <xref target="RFC8762"/>.</t> 

    <figure title="Session-Sender Test Packet" anchor="ure-dm-sender-test-packet"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv4 or IPv6 Address      .
 .  Destination IP Address=Session-Reflector IPv4 or IPv6 Address.
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Test Packet as specified in Section 4.2 of RFC 8762 |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
    </figure>

   <t>Timestamp field is eight bytes and use the format defined in Section
   4.2.1 of <xref target="RFC8762"/>.  It is recommended to use the IEEE 1588v2
   Precision Time Protocol (PTP) truncated 64-bit timestamp format
   <xref target="IEEE1588"/> as specified in <xref target="RFC8186"/>, with hardware support
   in segment routing networks is desired.</t>

   <t>When using the authenticated mode for delay measurement, the matching
   authentication type (e.g. HMAC-SHA-256) and key are user-configured
   on both the STAMP session-sender and session-reflector <xref target="RFC8762"/>.</t>

   <section title="Session-Sender Test Packet for links" anchor="sect-4.1.1"><t>
   The STAMP test packet as shown in Figure 2 
   are sent over the link for delay measurement which may be physical, virtual 
   or LAG (bundle), LAG (bundle) member, numbered/unnumbered link. 
   The local and remote IP addresses of the link are used as Source and Destination Addresses.</t>
    </section>

   <section title="Session-Sender Test Packet for SR Policy" anchor="sect-4.1.2"><t>
   The delay measurement for end-to-end SR path in segment routing is
   applicable to both end-to-end SR-MPLS and SRv6 Policies.</t>

   <t>The session-sender IPv4 or IPv6 address is used as the source address. 
   The endpoint IPv4 or IPv6 address is used as the destination
   address.  In the case of SR Policy with IPv4 endpoint
   of 0.0.0.0 or IPv6 endpoint of ::0 <xref target="I-D.ietf-spring-segment-routing-policy"/>,
   the loopback address from the range 127/8 for IPv4, or the loopback address ::1/128 
   for IPv6 is used as the destination address, respectively.</t>

    <section title="Session-Sender Test Packet for SR-MPLS Policy" anchor="sect-4.1.2.1"><t>
   The test packets for delay measurement of an
   end-to-end SR-MPLS Policy is sent using its SR-MPLS header containing the MPLS
   segment list as shown in Figure 3.</t>

    <figure title="Example Session-Sender Test Packet for SR-MPLS Policy" anchor="ure-test-packet-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                PSID                   | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Test Packet as shown in Figure 2               |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
    </figure>
   <t>The Segment List (SL) can be empty to indicate Implicit NULL label
   case for a single-hop SR Policy.</t>

   <t>The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the SR-MPLS Policy can be used as shown in Figure 3.</t>

    </section>

   <section title="Session-Sender Test Packet for SRv6 Policy" anchor="sect-4.1.2.2"><t>
   An SRv6 Policy setup using the SRv6 Segment Routing Header (SRH) and
   a Segment List as defined in <xref target="RFC8754"/>. 
   The SRv6 network programming is defined in 
   <xref target="I-D.ietf-spring-srv6-network-programming"/>. 
   The test packets for delay measurement of an end-to-end 
   SRv6 Policy is sent using its SRH with Segment List as shown in Figure 4.
   The procedure defined for upper-layer header processing for SRv6 SIDs in <xref target="I-D.ietf-spring-srv6-network-programming"/>
   is used to process the UDP header in the received test packets.</t>

    <figure title="Example Session-Sender Test Packet for SRv6 Policy" anchor="ure-test-packet-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv6 Address              .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Sender IPv6 Address              .
 .  Destination IP Address = Session-Reflector IPv6 Address      .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Test Packet as specified in Section 4.2 of RFC 8762 |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
    </figure>

    </section>
    </section>
    </section>

   <section title="Session-Reflector Test Packet" anchor="sect-4.2"><t>
   The STAMP session-reflector test packet is sent using the IP/UDP information from
   the received test packet.  The content of the reply test
   packet is shown in Figure 5.</t>

    <figure title="Session-Reflector Test Packet" anchor="ure-test-reply-packet"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Reflector IPv4 or IPv6 Address   .
 .  Destination IP Address = Source IP Address from Test Packet  .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Reflector                 .
 .  Destination Port = Source Port from Test Packet              .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Test Packet as specified in Section 4.3 of RFC 8762 |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
    </figure>
 
   <section title="One-way Delay Measurement Mode" anchor="sect-4.2.1"><t>
   In one-way delay measurement mode, a reply test packet
   as defined in Figure 5 is sent back to the session-sender,
   for both links and SR Policies.  In this mode, as per Reference Topology, 
   all timestamps T1, T2, T3, and T4 are collected by the test packets.
   However, only timestamps T1 and T2 are used to measure one-way delay as (T2 - T1).</t>

   <t>The session-sender address may not
   be reachable via IP route from the session-reflector.  The session-sender
   in this case needs to send its reachability path information to the
   session-reflector using Return Path TLV defined in <xref target="I-D.gandhi-ippm-stamp-srpm"/>.</t>

    </section>

   <section title="Two-way Delay Measurement Mode" anchor="sect-4.2.2"><t>
   In two-way delay measurement mode, when using a bidirectional
   path, a reply test packet as defined in Figure 5 is sent back
   to the session-sender on the same path (in-band) as the data traffic on the
   same reverse direction link or associated reverse SR path
   <xref target="I-D.ietf-pce-sr-bidir-path"/>.    In this mode, as per Reference Topology, 
   all timestamps T1, T2, T3, and T4 are collected by the test packets.
   All four timestamps are used to measure two-way delay as ((T4 - T1) - (T3 - T2)).</t>

   <t>For two-way delay measurement mode for links, the reply test packet is sent back on 
   the same incoming physical interface where the test packet is received.
   For this purpose, the Control Code is 
   set to "In-band Response Requested" <xref target="I-D.gandhi-ippm-stamp-srpm"/> in 
   the Session-Sender test packet.</t>

   <t>For two-way delay measurement mode for SR Policy, the session-reflector needs to send
   the reply test packet on a specific reverse path.  The session-sender
   node can request in the test packet to the session-reflector to
   send the reply test packet back on a given reverse path (e.g. 
   bidirectional path) using Return Path TLV defined in <xref target="I-D.gandhi-ippm-stamp-srpm"/>.</t>

   <section title="Session-Reflector Test Packet for SR-MPLS Policy" anchor="sect-4.2.2.1"><t>
   The packet content for sending reply test packet for two-way
   delay measurement of an end-to-end SR-MPLS Policy is shown in
   Figure 6.</t>

    <figure title="Example Session-Reflector Test Packet for SR-MPLS Policy" anchor="ure-test-reply-packet-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Test Packet as shown in Figure 5               |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
    </figure>
    <t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the forward SR Policy in the test packet can be used to find the
   associated reverse SR Policy <xref target="I-D.ietf-pce-sr-bidir-path"/> to send the 
   reply test packet for two-way delay measurement of SR Policy unless when using STAMP packet with Return
   Path TLV.</t>

    </section>

   <section title="Session-Reflector Test Packet for SRv6 Policy" anchor="sect-4.2.2.2"><t>
   The packet content for sending reply test packet on the
   same path (in-band) as the data traffic for two-way delay 
   measurement of an end-to-end SRv6 Policy with SRH is shown in Figure 7.
   The procedure defined for upper-layer header processing for SRv6 SIDs
   in <xref target="I-D.ietf-spring-srv6-network-programming"/>
   is used to process the UDP header in the received reply test packets.</t>

    <figure title="Example Session-Reflector Test Packet for SRv6 Policy" anchor="ure-test-reply-packet-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Session-Reflector IPv6 Address           .
 .  Destination IP Address = Destination IPv6 Address            .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header (as needed)                                         |
 .  Source IP Address = Session-Reflector IPv6 Address           .
 .  Destination IP Address = Source IPv6 Address from Test Packet.
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Session-Sender                    .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = Test Packet as specified in Section 4.3 of RFC 8762 |
 .                                                               .
 +---------------------------------------------------------------+
 
]]></artwork>
    </figure>

    </section>
    </section>

   <section title="Loopback Measurement Mode" anchor="sect-4.2.3"><t>
   The loopback measurement mode can be used to measure round-trip delay
   of a bidirectional SR path.  The IP header of the session-sender test 
   packet contains the destination address equals to the session-sender address
   and the source address equals to the session-reflector address. Optionally,
   the test packet can carry the reverse path information (e.g.
   reverse path label stack for SR-MPLS) as part of the SR header.  The
   received test packets are not punted at the session-reflector and it does
   not process them and generate reply test packets.
   In this mode, as the test packet is not punted on the session-reflector for processing,
   the session-sender copies the 'Sequence Number' in 'Session-Sender Sequence Number' directly before sending the test packet.
   In this mode, as per Reference Topology,
   the timestamps T1 and T4 are collected by the test packets.
   Both these timestamps are used to measure round-trip delay as (T4 - T1).</t>
     </section>
   </section>

    <section title="Delay Measurement for P2MP SR Policies" anchor="sect-4.6"> <t>
   The Point-to-Multipoint (P2MP) SR path
   that originates from a root node terminates on multiple destinations called leaf nodes 
   (e.g. P2MP SR Policy <xref target="I-D.ietf-pim-sr-p2mp-policy"/> 
   or P2MP Transport <xref target="I-D.shen-spring-p2mp-transport-chain"/>).</t>

   <t>The procedures for delay measurement described in this
   document for P2P SR Policies are also equally applicable to the P2MP SR Policies. 
   The procedure for one-way delay measurement mode is defined as following:</t>

   <t><list style="symbols"><t>The session-sender root node sends test packets using the
      Tree-SID defined in <xref target="I-D.ietf-pim-sr-p2mp-policy"/> for the
      P2MP SR-MPLS Policy as shown in Figure 8.</t>

      <t>The test packets can contain
      the replication SID as defined in <xref target="I-D.ietf-spring-sr-replication-segment"/>.</t>

      <t>The Destination Address is set to the loopback 
      address from range 127/8 for IPv4, or the loopback address ::1/128 for IPv6 address.</t>

      <t>Each session-reflector leaf node sends its IP address in the Source
      Address of the reply test packets as shown in Figure 8.  This
      allows the session-sender root node to identify the session-reflector leaf nodes
      of the P2MP SR Policy.</t>

      <t>The P2MP root node measures the delay 
      for each P2MP leaf node of the end-to-end P2MP SR Policy.</t>

    </list>
    </t>

    <figure title="Example Session-Sender Test Packet with Tree-SID for SR-MPLS Policy" anchor="ure-with-replication-segment-for-sr-mpls-policy"><artwork><![CDATA[

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |              Tree-SID                 | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Test Packet as shown in Figure 2                            |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
    </figure>


   <t>The test packets can also be sent using
   the scheme defined for P2MP Transport using Chain Replication that may contain Bud SID as defined in 
   <xref target="I-D.shen-spring-p2mp-transport-chain"/>.</t>

   <t>The considerations for two-way delay measuremewnt mode for 
   P2MP SR Policy (e.g. for bidirectional SR path) are outside the scope of this document.</t>

    </section>

      <section title="Additional Test Packet Processing Rules" anchor="sect-4.5"><t>
   The processing rules defined in this section are applicable to the
   STAMP packets for links and end-to-end SR paths including SR Policies.</t>        
        
   <section title="TTL" anchor="sect-4.5.1"><t>
   The TTL field in the IPv4 and MPLS headers of the
   test packets is set to 255, except in the following cases.</t>

   <t>When using the Destination IPv4 Address from range 127/8, the TTL field in the IPv4 header is set to 1.</t>

   <t>For link delay, the TTL field in the test packet is set to 1 in one-way and two-way delay measurement modes.</t>

    </section>

   <section title="Hop Limit" anchor="sect-4.5.2"><t>
   The Hop Limit field in the IPv6 and SRH headers of the
   test packets is set to 255, except in the following cases.</t>

   <t>When using the Destination IPv6 Address of loopback address ::1/128, 
   the Hop Limit field in the IPv6 header is set to 1.</t>

   <t>For link delay, the Hop Limit field in the test packet is set to 1 in one-way and two-way delay measurement modes.</t>

   </section>

   <section title="Router Alert Option" anchor="sect-4.5.3"><t>
   The Router Alert IP option (RAO) <xref target="RFC2113"/> is not set in the test packets for
   links and end-to-end SR paths.</t>

   </section>
   </section>

   </section>

   <section title="ECMP Support for SR Policies" anchor="sect-5"><t>
   An SR Policy can have ECMPs between the source and transit nodes,
   between transit nodes and between transit and destination nodes.
   Usage of Anycast SID <xref target="RFC8402"/> by an SR Policy can result in ECMP
   paths via transit nodes part of that Anycast group.  The test
   packets need to be sent to traverse different ECMP paths to measure
   delay of an SR Policy.</t>

   <t>Forwarding plane has various hashing functions available to forward
   packets on specific ECMP paths.  The mechanisms described in
   <xref target="RFC8029"/> and <xref target="RFC5884"/> for 
   handling ECMPs are also applicable to the
   delay measurement.  In IPv4 header of the test packets,
   sweeping of Destination Address from range 127/8 can be used to exercise
   particular ECMP paths.  As specified in <xref target="RFC6437"/>, Flow Label field in
   the outer IPv6 header can also be used for sweeping.</t>

   <t>The Destination Node Address TLV <xref target="I-D.gandhi-ippm-stamp-srpm"/> can be sent 
   in the session-sender test packet to identify the intended destination node.
   The session-reflector MUST NOT send reply test packet if it
   is not the intended destination node in the Destination Node Address TLV <xref target="I-D.gandhi-ippm-stamp-srpm"/>.</t> 

   </section>

   <section title="Syntheic Loss Measurement" anchor="sect-6"><t>
   Synthetic packet loss measurement is applicable for connectivity verification and continuity check in an SR network.
   The procedure defined in this document for delay measurement using STAMP 
   can also be applied for synthetic packet loss measurement for links and end-to-end SR paths.
   The procedure uses sequence number in the STAMP test packets as 
   described in Section 4 "Thoery of Operation" of <xref target="RFC8762"/>.</t>
   </section>

   <section title="Liveness and Connectivity Loss Monitoring" anchor="sect-8"><t>
   Liveness monitoring is applicable for connectivity verification and continuity check in an SR network.
   The procedure defined in this document for delay measurement using STAMP 
   can also be applied to report the connectivity loss metric for links and end-to-end SR paths. 
   Connectivity loss is notified when consecutive N number of reply test packets are
   not received back at the session-sender, where N is locally provisioned value.</t>

   <t>Note that for one-way and two-way delay measurement modes, the connectivity loss detection 
   interval and scale for number of STAMP test sessions need to account for 
   the processing of the STAMP test packets on the session-reflector which need to be punted from the forwarding fast path
   (to slow path or control plane) and reply test packets need to be injected.
   The scale is improved by using the STAMP test packets in loopback mode as described in Section 4.2.3.</t>
   </section>

   <section title="Direct Measurement" anchor="sect-7"><t>
   Direct measurement is applicable to detect data packet loss in an SR network.
   The "Direct Measurement" TLV (Type 5) is defined in <xref target="RFC8972"/> 
   for packet loss detection that can be used for links and end-to-end SR paths. 
   The Path Segment ID (PSID) is used
   to count receive data packets on the session-reflector node.</t>

   <t>Note that the existing "Direct Measurement" TLV (Type 5) <xref target="RFC8972"/> does not
   support 64-bit counters, byte counters and couters per traffic class. 
   In addition, it does not support out-of-ordering of data packets,
   as block number for the counters is not carried.</t>
   </section>

   <section title="Security Considerations" anchor="sect-9"><t>
   The performance measurement is intended for deployment in
   well-managed private and service provider networks.  As such, it
   assumes that a node involved in a measurement operation has
   previously verified the integrity of the path and the identity of the
   far-end session-reflector.</t>

   <t>If desired, attacks can be mitigated by performing basic validation
   and sanity checks, at the session-sender, of the counter or timestamp fields
   in received measurement reply test packets.  The minimal state
   associated with these protocols also limits the extent of measurement
   disruption that can be caused by a corrupt or invalid packet to a
   single test cycle.</t>

   <t>Use of HMAC-SHA-256 in the authenticated mode protects the data
   integrity of the test packets.  SRv6 has HMAC protection
   authentication defined for SRH <xref target="RFC8754"/>.
   Hence, test packets for SRv6 may not need authentication mode.
   Cryptographic measures may be enhanced by the correct configuration
   of access-control lists and firewalls.</t>

    </section>

   <section title="IANA Considerations" anchor="sect-10"><t>
       This document does not require any IANA action.</t>

    </section>

    </middle>

    <back>
    <references title="Normative References">
    &RFC0768;
    &RFC2119;
    &RFC8174;
    &RFC8762;
    &RFC8972;
    &I-D.gandhi-ippm-stamp-srpm;        
    </references>
    <references title="Informative References">
    <reference anchor="IEEE1588"><front>
    <title>1588-2008 IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems</title>
    <author>
    <organization>IEEE</organization>
    </author>

    <date month="March" year="2008"/>
    </front>

    </reference>
    &RFC2113;
    &RFC5884;
    &RFC6437;
    &RFC8029;
    &RFC8186;
    &RFC8402;
    &RFC8754;
    &I-D.ietf-spring-segment-routing-policy;
    &I-D.ietf-spring-sr-replication-segment;
    &I-D.shen-spring-p2mp-transport-chain;
    &I-D.ietf-pim-sr-p2mp-policy;
    &I-D.ietf-spring-mpls-path-segment;
    &I-D.ietf-spring-srv6-network-programming;
    &I-D.ietf-ippm-stamp-yang;
    &I-D.ietf-pce-sr-bidir-path;
    </references>
    <section title="Acknowledgments" numbered="no" anchor="acknowledgments"><t>
   The authors would like to thank Thierry Couture for the discussions
   on the use-cases for Performance Measurement in segment routing.  The authors
   would also like to thank Greg Mirsky, Gyan Mishra, Xie Jingrong, and Mike Koldychev for reviewing this document and
   providing useful comments and suggestions.  Patrick Khordoc and Radu
   Valceanu, both from Cisco Systems have helped significantly improve
   the mechanisms defined in this document.  The authors
   would also like to thank Sam Aldrin for the discussions to check for
   broken path.</t>

    </section>

    </back>

    </rfc>
