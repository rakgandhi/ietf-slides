<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC0768 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.0768.xml">
<!ENTITY RFC2119 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC8174 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY RFC8762 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8762.xml">
<!ENTITY I-D.ietf-ippm-stamp-option-tlv SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-ippm-stamp-option-tlv.xml">
<!ENTITY I-D.ietf-6man-spring-srv6-oam SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-6man-spring-srv6-oam.xml">
<!ENTITY RFC2104 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2104.xml">
<!ENTITY RFC2113 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.2113.xml">
<!ENTITY RFC4868 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.4868.xml">
<!ENTITY RFC5884 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.5884.xml">
<!ENTITY RFC6335 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6335.xml">
<!ENTITY RFC6437 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6437.xml">
<!ENTITY RFC6936 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.6936.xml">
<!ENTITY RFC7506 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7506.xml">
<!ENTITY RFC7820 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7820.xml">
<!ENTITY RFC8029 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8029.xml">
<!ENTITY RFC8085 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8085.xml">
<!ENTITY RFC8186 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8186.xml">
<!ENTITY RFC8200 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8200.xml">
<!ENTITY RFC8321 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8321.xml">
<!ENTITY RFC8402 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8402.xml">
<!ENTITY RFC8754 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8754.xml">
<!ENTITY I-D.ietf-spring-segment-routing-policy SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-segment-routing-policy.xml">
<!ENTITY I-D.voyer-spring-sr-replication-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.voyer-spring-sr-replication-segment.xml">
<!ENTITY I-D.ietf-spring-mpls-path-segment SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-mpls-path-segment.xml">
<!ENTITY I-D.ietf-spring-srv6-network-programming SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-spring-srv6-network-programming.xml">
<!ENTITY I-D.ietf-pce-binding-label-sid SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-binding-label-sid.xml">
<!ENTITY I-D.gandhi-mpls-ioam-sr SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.gandhi-mpls-ioam-sr.xml">
<!ENTITY I-D.ali-spring-ioam-srv6 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ali-spring-ioam-srv6.xml">
<!ENTITY I-D.ietf-pce-sr-bidir-path SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-pce-sr-bidir-path.xml">
]>
<rfc submissionType="IETF" docName="draft-gandhi-spring-stamp-srpm-01" category="std" ipr="trust200902">
	<!-- Generated by id2xml 1.5.0 on 2020-02-06T01:41:26Z -->
	<?rfc compact="yes"?>
	<?rfc text-list-symbols="oo*+-"?>
	<?rfc subcompact="no"?>
	<?rfc sortrefs="no"?>
	<?rfc symrefs="yes"?>
	<?rfc strict="yes"?>
	<?rfc toc="yes"?>
	<front>
	<title abbrev="STAMP for Segment Routing">Performance Measurement Using STAMP for Segment Routing Networks</title>
	<author fullname="Rakesh Gandhi" initials="R." role="editor" surname="Gandhi">
	<organization>Cisco Systems, Inc.</organization>
	<address><postal><street>Canada</street>
	</postal>
        <email>rgandhi@cisco.com</email>
	</address>
	</author>

	<author fullname="Clarence Filsfils" initials="C." surname="Filsfils">
	<organization>Cisco Systems, Inc.</organization>
        <address>
        <email>cfilsfil@cisco.com</email>
	</address>
	</author>

	<author fullname="Daniel Voyer" initials="D." surname="Voyer">
	<organization>Bell Canada</organization>
        <address>
        <email>daniel.voyer@bell.ca</email>
	</address>
	</author>

	<author fullname="Mach(Guoyi) Chen" initials="M." surname="Chen">
	<organization>Huawei</organization>
        <address>
        <email>mach.chen@huawei.com</email>
	</address>
	</author>

	<author fullname="Bart Janssens" initials="B." surname="Janssens">
	<organization>Colt</organization>
        <address>
	<email>Bart.Janssens@colt.net</email>
	</address>
	</author>

	<date day="10" month="May" year="2020"/>
	<workgroup>SPRING Working Group</workgroup>
	<abstract><t>
   Segment Routing (SR) leverages the source routing paradigm.  SR is
   applicable to both Multiprotocol Label Switching (SR-MPLS) and IPv6
   (SRv6) data planes.  This document specifies procedure for sending
   and processing probe query and response messages for Performance
   Measurement (PM) in Segment Routing networks.  The procedure uses the
   mechanisms defined in RFC 8762 (Simple Two-Way Active Measurement Protocol (STAMP))
   for Delay Measurement, and uses the mechanisms defined in this
   document for Loss Measurement.  The procedure specified is applicable
   to SR-MPLS and SRv6 data planes and is used for both Links and
   end-to-end SR Paths including SR Policies.</t>

	</abstract>
	</front>

	<middle>
	<section title="Introduction" anchor="sect-1"><t>
   Segment Routing (SR) leverages the source routing paradigm and
   greatly simplifies network operations for Software Defined Networks
   (SDNs).  SR is applicable to both Multiprotocol Label Switching
   (SR-MPLS) and IPv6 (SRv6) data planes.  SR takes advantage of the
   Equal-Cost Multipaths (ECMPs) between source and transit nodes,
   between transit nodes and between transit and destination nodes.  SR
   Policies as defined in <xref target="I-D.ietf-spring-segment-routing-policy"/> are used
   to steer traffic through a specific, user-defined paths using a stack
   of Segments.  Built-in SR Performance Measurement (PM) is one of the
   essential requirements to provide Service Level Agreements (SLAs).</t>

   <t>The Simple Two-way Active Measurement Protocol (STAMP) provides
   capabilities for the measurement of various performance
   metrics in IP networks using probe messages <xref target="RFC8762"/>. 
   It eliminates the need for control-channel signaling by using
   configuration data model to provision a test-channel (e.g. UDP paths). 
   <xref target="I-D.ietf-ippm-stamp-option-tlv"/>
   defines TLV extensions for STAMP messages.</t>

   <t>The STAMP message with a TLV for "direct measurement" can be used for combined Delay + Loss
   measurement <xref target="I-D.ietf-ippm-stamp-option-tlv"/>. However,  in 
   order to use only for loss measurement purpose, it requires the node to 
   support the delay measurement messages and support timestamp for these messages 
   (which may also require clock synchronization). 
   Furthermore, for hardware-based counter collection for direct-mode loss meaurement, 
   the optional TLV based processing adds unnecessary overhead
   (as counters are not at well-known locations).</t>

   <t>
   This document specifies procedures for sending and processing probe
   query and response messages for Performance Measurement in SR
   networks.  The procedure uses the mechanisms defined in <xref target="RFC8762"/> 
   (STAMP) (including the TLV extensions) for Delay Measurement (DM), and uses the
   mechanisms defined in this document for Loss Measurement.  The
   procedure specified is applicable to SR-MPLS and SRv6 data planes and
   are used for both Links and end-to-end SR Paths including SR Policies.  This document
   also defines mechanisms for handling ECMPs of SR Paths for
   performance delay measurement.  Unless otherwise specified, the mechanisms 
   defined in <xref target="RFC8762"/> and <xref target="I-D.ietf-ippm-stamp-option-tlv"/>
   are not modified by this document.</t>
	</section>

	<section title="Conventions Used in This Document" anchor="sect-2"><section title="Requirements Language" anchor="sect-2.1"><t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC2119"/> <xref target="RFC8174"/>
   when, and only when, they appear in all capitals, as shown here.</t>

	</section>

	<section title="Abbreviations" anchor="sect-2.2"><t>
   BSID: Binding Segment ID.</t>

	<t>
   DM: Delay Measurement.</t>

	<t>
   ECMP: Equal Cost Multi-Path.</t>

	<t>
   HMAC: Hashed Message Authentication Code.</t>

	<t>
   LM: Loss Measurement.</t>

	<t>
   MPLS: Multiprotocol Label Switching.</t>

	<t>
   NTP: Network Time Protocol.</t>

	<t>
   OWAMP: One-Way Active Measurement Protocol.</t>

	<t>
   PM: Performance Measurement.</t>

	<t>
   PSID: Path Segment Identifier.</t>

	<t>
   PTP: Precision Time Protocol.</t>

	<t>
   SID: Segment ID.</t>

	<t>
   SL: Segment List.</t>

	<t>
   SR: Segment Routing.</t>

	<t>
   SRH: Segment Routing Header.</t>

	<t>
   SR-MPLS: Segment Routing with MPLS data plane.</t>

	<t>
   SRv6: Segment Routing with IPv6 data plane.</t>

	<t>
   SSID: STAMP Session Identifier.</t>

	<t>
   STAMP: Simple Two-way Active Measurement Protocol.</t>

	<t>
   TC: Traffic Class.</t>

	</section>

	<section title="Reference Topology" anchor="sect-2.3"><t>
   In the reference topology shown below, the sender node R1 initiates a
   probe query for performance measurement and the reflector node R5
   sends a probe response for the query message received.  The probe
   response is sent to the sender node R1.  The nodes R1 and R5 may be
   directly connected via a Link or there
   exists a Point-to-Point (P2P) SR Path e.g. SR Policy
   <xref target="I-D.ietf-spring-segment-routing-policy"/> on node R1 with destination to
   node R5.  In case of Point-to-Multipoint (P2MP), SR Policy
   originating from source node R1 may terminate on multiple destination
   leaf nodes <xref target="I-D.voyer-spring-sr-replication-segment"/>.</t>

	<figure><artwork><![CDATA[

            +-------+ t1     Query     t2 +-------+
            |       | - - - - - - - - - ->|       |
            |   R1  |=====================|   R5  |
            |       |<- - - - - - - - - - |       |
            +-------+ t4     Response  t3 +-------+
             Sender                       Reflector

                      Reference Topology
]]></artwork>
	</figure>
	</section>

	</section>

	<section title="Overview" anchor="sect-3"><t>
   For one-way and two-way delay measurements in Segment
   Routing networks, the probe messages defined in
   <xref target="RFC8762"/> are used.  For direct-mode and
   inferred-mode loss measurements in Segment Routing networks, the
   messages defined in this document are used. Separate
   UDP destination port numbers are user-configured for delay and loss
   measurements from the range specified in <xref target="RFC8762"/>.  The
   sender uses the UDP port number following the guidelines specified in
   <xref target="sect-6"/> in <xref target="RFC6335"/>. The UDP destination port
   862 can be used for delay measurement probes by default except for the case
   where the reflector needs to process STAMP TLVs. 
   For both Links and end-to-end SR Paths including SR Policies,
   no PM session for delay or loss measurement is created on the
   reflector node R5 <xref target="RFC8762"/>.</t>

	<t>
   For Performance Measurement, probe query and response messages are
   sent as following:</t>

	<t><list style="symbols"><t>For Delay Measurement, the probe messages are sent on the
      congruent path of the data traffic by the sender node, and are
      used to measure the delay experienced by the actual data traffic
      flowing on the Links and SR Paths.</t>

	<t>For Loss Measurement, the probe messages are sent on the congruent
      path of the data traffic by the sender node, and are used to
      collect the receive traffic counters for the incoming link or
      incoming SID where the probe query messages are received at the
      reflector node (incoming link or incoming SID needed since the
      reflector node does not have PM session state present).</t>

	</list>
	</t>

	<t>
   The In-Situ Operations, Administration, and Maintenance (IOAM)
   mechanisms for SR-MPLS defined in <xref target="I-D.gandhi-mpls-ioam-sr"/> and for
   SRv6 defined in <xref target="I-D.ali-spring-ioam-srv6"/> are used to carry PM
   information such as timestamp in-band as part of the data packets,
   and are outside the scope of this document.</t>

	<section title="Example Provisioning Model" anchor="sect-3.1"><t>
   An example of a provisioning model and typical measurement parameters for each user-configured destination UDP port 
   for performance delay and loss measurements is shown in the following
   Figure 1:</t>

   <figure title="Example Provisioning Model" anchor="ure-example-provisioning-model"><artwork><![CDATA[

                          +------------+
                          | Controller |
                          +------------+
Destination UDP Port           /  \         Destination UDP port
Measurement Protocol          /    \        Measurement Protocol
Measurement Type             /      \       Measurement Type
  Delay/Loss                /        \        Delay/Loss
Authentication Mode & Key  /          \     Authentication Mode & Key
Timestamp Format          /            \    Loss Measurement Mode
Delay Measurement Mode   /              \
Loss Measurement Mode   /                \
                       v                  v
                  +-------+            +-------+
                  |       |            |       |
                  |   R1  |============|   R5  |
                  |       |            |       |
                  +-------+            +-------+
                   Sender              Reflector
]]></artwork>
	</figure>

    <t>Example of Measurement Protocol is STAMP, 
    example of the Timestamp Format is PTPv2 <xref target="IEEE1588"/> or NTP 
    and example of the Loss Measurement
    mode is inferred-mode or direct-mode.</t>

    <t>The mechanisms to provision the
    sender and reflector nodes are outside the scope of this document.</t>

    <t>The reflector node R5 uses the parameters for the timestamp format and
    delay measurement mode (i.e. one-way or two-way mode)
    from the received probe query message.</t>
	</section>

	</section>

	<section title="Probe Messages" anchor="sect-4"><section title="Probe Query Message" anchor="sect-4.1"><t>
   The probe messages defined in <xref target="RFC8762"/> are used
   for Delay Measurement for Links and end-to-end SR Paths including SR 
   Policies. For Loss Measurement, the probe messages defined in this document are used.</t>

	<t>
   The Sender IPv4 or IPv6 address is used as the source address. 
   The reflector IPv4 or IPv6 address is used as the destination
   address.  In the case of SR Policy with IPv4 endpoint
   of 0.0.0.0 or IPv6 endpoint of ::0
   <xref target="I-D.ietf-spring-segment-routing-policy"/>, 
   the address in the range of 127/8 for IPv4 or
   ::FFFF:127/104 for IPv6 is used as the destination address, respectively.</t> 

   <section title="Delay Measurement Query Message" anchor="sect-4.1.1"><t>
   The message content for Delay Measurement probe query message using
   UDP header <xref target="RFC0768"/> is shown in Figure 2.  The DM probe query message
   is sent with user-configured Destination UDP port number for DM.  The
   Destination UDP port cannot be used as Source port, since the message
   does not have any indication to distinguish between the query and
   response message.  The payload of the DM probe query message contains the delay
   measuremen message defined in <xref target="RFC8762"/>.</t> 

	<figure title="DM Probe Query Message" anchor="ure-dm-probe-query-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Sender IPv4 or IPv6 Address              .
 .  Destination IP Address = Reflector IPv4 or IPv6 Address      .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Sender                            .
 .  Destination Port = User-configured Port for Delay Measurement.
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.2 of RFC 8762  |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	<t>
   Timestamp field is eight bytes and use the format defined in Section
   4.2.1 of <xref target="RFC8762"/>.  It is recommended to use the IEEE 1588v2
   Precision Time Protocol (PTP) truncated 64-bit timestamp format
   <xref target="IEEE1588"/> as specified in <xref target="RFC8186"/>, with hardware support
   in Segment Routing networks.</t>


	<section title="Delay Measurement Authentication Mode" anchor="sect-4.1.1.1"><t>
   When using the authenticated mode for delay measurement, the matching
   authentication type (e.g. HMAC-SHA-256) and key are user-configured
   on both the sender and reflector nodes.  A separate user-configured
   destination UDP port is used for the delay measurement in
   authentication mode due to the different probe message format.</t>

	</section>

	</section>



	<section title="Loss Measurement Query Message" anchor="sect-4.1.2"><t>
   The message content for Loss Measurement probe query message using
   UDP header <xref target="RFC0768"/> is shown in Figure 3. The LM probe query message
   is sent with user-configured Destination UDP port number for LM, 
   which is a different Destination UDP port number than DM.
   Separate Destination UDP ports are used for direct-mode and
   inferred-mode loss measurements.  The Destination UDP port cannot be
   used as Source port, since the message does not have any indication
   to distinguish between the query and response message.  The LM probe query
   message contains the payload for loss measurement as defined in
   Figure 7 and Figure 8.</t>

	<figure title="LM Probe Query Message" anchor="ure-lm-probe-query-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Sender IPv4 or IPv6 Address              .
 .  Destination IP Address = Reflector IPv4 or IPv6 Address      .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Sender                            .
 .  Destination Port = User-configured Port for Loss Measurement .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = LM Message as specified in Figure 7 or 8            |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	<section title="Loss Measurement Authentication Mode" anchor="sect-4.1.2.1"><t>
   When using the authenticated mode for loss measurement, the matching
   authentication type (e.g. HMAC-SHA-256) and key are user-configured
   on both the sender and reflector nodes.  A separate user-configured
   destination UDP port is used for the loss measurement in
   authentication mode due to the different message format.</t>

    </section>
    </section>

	<section title="Probe Query for Links" anchor="sect-4.1.3"><t>
   The probe query message as defined in Figure 2 for delay measurement and 
   Figure 3 for loss measurement is sent on the
   congruent path of the data traffic.  The probe messages are routed 
   over the Link for both delay and loss measurement.</t> 
	</section>

	<section title="Probe Query for End-to-end Measurement for SR Policy" anchor="sect-4.1.4"><t>
   The performance delay and loss measurement for segment routing is
   applicable to both SR-MPLS and SRv6 Policies.</t>

	<section title="Probe Query Message for SR-MPLS Policy" anchor="sect-4.1.4.1"><t>
   The probe query messages for end-to-end performance measurement of an
   SR-MPLS Policy is sent using its SR-MPLS header containing the MPLS
   segment list as shown in Figure 4.</t>

	<figure title="Example Probe Query Message for SR-MPLS Policy" anchor="ure-probe-query-message-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                PSID                   | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Segment List (SL) can be empty to indicate Implicit NULL label
   case for a single-hop SR Policy.</t>

	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the SR-MPLS Policy is used for accounting received traffic on the
   egress node for loss measurement.</t>

	</section>

	<section title="Probe Query Message for SRv6 Policy" anchor="sect-4.1.4.2"><t>
   An SRv6 Policy setup using the SRv6 Segment Routing Header (SRH) and
   a Segment List as defined in <xref target="RFC8754"/>. 
   For SRv6, network programming is defined in 
   <xref target="I-D.ietf-spring-srv6-network-programming"/>. 
   The probe query messages for end-to-end performance measurement of an
   SRv6 Policy is sent using its SRH with Segment List as shown in Figure
   5.</t>

	<figure title="Example Probe Query Message for SRv6 Policy" anchor="ure-probe-query-message-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Sender IPv6 Address                      .
 .  Destination IP Address = Next Hop IPv6 Address               .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header (Optional)                                          |
 .  Source IP Address = Sender IPv6 Address                      .
 .  Destination IP Address = Reflector IPv6 Address              .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Sender                            .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.2 of RFC 8762| |
 . Payload = LM Message as specified in Figure 7 or 8            .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>


	<t>
   For delay measurement of SRv6 Policy using SRH, END function END.OTP
   <xref target="I-D.ietf-6man-spring-srv6-oam"/> is used with the target SRv6 SID to punt probe
   messages on the target node, as shown in Figure 5.  Similarly, for
   loss measurement of SRv6 Policy, END function END.OP
   <xref target="I-D.ietf-6man-spring-srv6-oam"/> is used with target SRv6 SID to punt probe
   messages on the target node.</t>

	</section>

</section>

	<section title="Control Code Field for STAMP Messages" anchor="sect-4.1.5">
	<t>
   The Control Code field is defined for delay and loss measurement probe query and response messages
   for STAMP protocol in unauthenticated and authenticated modes.  
   The modified delay measurement probe query and response message format for STAMP is shown in Figure 6. 
   This message format is backwards
   compatible with the message format defined in STAMP <xref target="RFC8762"/> as its reflector MUST
   ignore the received field (previously identified as MBZ).
   The usage of the Control Code is not limited to the SR networks and can be used for non-SR paths in a network.</t>

   <figure title="Sender and Reflector Control Code in STAMP DM Message" anchor="ure-se-control-code-in-stamp-message"><artwork><![CDATA[
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                          Timestamp                            |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |         Error Estimate        | SSID                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |         MBZ                                   |Se Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .



 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Session-Sender Error Estimate | MBZ           |Re Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |Ses-Sender TTL |                 MBZ                           |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .

]]></artwork>
	</figure>

   <t>
   Sender Control Code: Set as follows in STAMP probe query message.</t>
   <t>  </t>
   <t>
   For a Query:</t>

	<t><list hangIndent="4" style="hanging"><t>
       0x0: Out-of-band Response Requested.  Indicates that the probe response
       is not required over the same path in the reverse direction.
       This is also the default behavior.</t>

	</list>
	</t>

	<t><list hangIndent="4" style="hanging"><t>
       0x1: In-band Response Requested.  Indicates that this query has
       been sent over a bidirectional path and the probe response is required
       over the same path in the reverse direction.</t> 
	</list>
	</t>


   <t>
   Reflector Control Code: Set as follows in STAMP probe response message.</t>
   <t>  </t>

	<t><list style="hanging" hangIndent="4"><t hangText="For a Response:">
	<vspace blankLines="1"/>
       0x1: Error - Invalid Message.  Indicates that the operation
       failed because the received query message could not be processed.
	</t>
	<t> Additional Error Codes to be defined in future.</t>

	</list>
	</t>

	</section>

	<section title="Loss Measurement Query Message Formats for STAMP" anchor="sect-4.1.6">
   <t>In this document, STAMP probe query messages for
   loss measurement are defined as shown in Figure 7 and Figure 8. The message
   formats are hardware efficient due to 
   well-known locations of the counters and payload
   small in size.  They are stand-alone and similar to the delay
   measurement message formats (e.g. location of the Counter and Timestamp). They also  
   do not require backwards
   compatibility and support for the existing DM message formats from
   <xref target="RFC8762"/> as different user-configured destination UDP 
   port is used for loss measurement.</t>

	<figure title="STAMP LM Probe Query Message - Unauthenticated Mode" anchor="ure-lm-probe-query-message-format"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Transmit Counter                       |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  | Block Number  | SSID                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |         MBZ                                   |Se Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 |                        MBZ (24 octets)                        |
 |                                                               |
 |                                                               |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>

	<figure title="STAMP LM Probe Query Message - Authenticated Mode" anchor="ure-lm-probe-query-message-format-authenticated-mode"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (12 octets)                        |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Transmit Counter                       |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  | Block Number  | SSID                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |         MBZ                                   |Se Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (64 octets)                        |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 |                        HMAC (16 octets)                       |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>

	<t>
   Sequence Number (32-bit): As defined in <xref target="RFC8762"/>.</t>

	<t>
   Transmit Counter (64-bit): The number of packets or octets sent by
   the sender node in the query message and by the reflector node in the
   response message.  The counter is always written at the well-known
   location in the probe query and response messages.</t>

	<t>
   Receive Counter (64-bit): The number of packets or octets received at
   the reflector node.  It is written by the reflector node in the probe
   response message.</t>

	<t>
   Sender Counter (64-bit): This is the exact copy of the transmit
   counter from the received query message.  It is written by the
   reflector node in the probe response message.</t>

	<t>
   Sender Sequence Number (32-bit): As defined in <xref target="RFC8762"/>.</t>

	<t>
   Sender TTL: As defined in Section 7.1.</t>

	<t><list style="hanging" hangIndent="3"><t hangText="LM Flags: The meanings of the Flag bits are:">
	<vspace blankLines="1"/>
	X: Extended counter format indicator.  Indicates the use of
      extended (64-bit) counter values.  Initialized to 1 upon creation
      (and prior to transmission) of an LM Query and copied from an LM
      Query to an LM response.  Set to 0 when the LM message is
      transmitted or received over an interface that writes 32-bit
      counter values.
	<vspace blankLines="1"/>
	B: Octet (byte) count.  When set to 1, indicates that the Counter
      1-4 fields represent octet counts.  The octet count applies to all
      packets within the LM scope, and the octet count of a packet sent
      or received includes the total length of that packet (but excludes
      headers, labels, or framing of the channel itself).  When set to
      0, indicates that the Counter fields represent packet counts.
	</t>

	</list>
	</t>

	<t>
   Block Number (8-bit): The Loss Measurement using Alternate-Marking
   method defined in <xref target="RFC8321"/> requires to color the data traffic.  To
   be able to compare the transmit and receive traffic counters of the
   matching color,  the Block Number (or color) of the traffic counters
   is carried by the probe query and response messages for loss
   measurement.</t>

	<t>
   HMAC: The PM probe message in authenticated mode includes a key Hashed
   Message Authentication Code (HMAC) (<xref target="RFC2104"/>) hash.  Each probe
   query and response messages are authenticated by adding Sequence
   Number with Hashed Message Authentication Code (HMAC) TLV.  It can
   use HMAC-SHA-256 truncated to 128 bits (similarly to the use of it in
   IPSec defined in <xref target="RFC4868"/>); hence the length of the HMAC field is 16
   octets.</t>

	<t>
   HMAC uses its own key and the mechanism to distribute the HMAC key is
   outside the scope of this document.</t>

	<t>
   In authenticated mode, only the sequence number is encrypted, and the
   other payload fields are sent in clear text.  The probe message MAY
   include Comp.MBZ (Must Be Zero) variable length field to align the
   packet on 16 octets boundary.</t>

	</section>

	</section>

	<section title="Probe Response Message" anchor="sect-4.2"><t>
   The probe response message is sent using the IP/UDP information from
   the received probe query message.  The content of the probe response
   message is shown in Figure 9.</t>

	<figure title="Probe Response Message" anchor="ure-probe-response-message"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Reflector IPv4 or IPv6 Address           .
 .  Destination IP Address = Source IP Address from Query        .
 .  Protocol = UDP                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Reflector                         .
 .  Destination Port = Source Port from Query                    .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.3 of RFC 8762| |
 . Payload = LM Message as specified in Figure 12 or 13          .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<section title="One-way Measurement Mode" anchor="sect-4.2.1"><t>
   In one-way performance measurement mode, the probe response message
   as defined in Figure 9 is sent back out-of-band to the sender node,
   for both Links and SR Policies. The Sender Control Code is set to
   "Out-of-band Response Requested". 
   In this delay measurement mode, as per Reference Topology, 
   all timestamps t1, t2, t3, and t4 are collected by the probes.
   However, only timestamps t1 and t2 are needed to measure one-way delay.</t>
	</section>

	<section title="Two-way Measurement Mode" anchor="sect-4.2.2"><t>
   In two-way performance measurement mode, when using a bidirectional
   path, the probe response message as defined in Figure 9 is sent back
   to the sender node on the congruent path of the data traffic on the
   same reverse direction Link or associated reverse SR Policy
   <xref target="I-D.ietf-pce-sr-bidir-path"/>.  The Sender Control Code is 
   set to "In-band Response Requested".
   In this delay measurement mode, as per Reference Topology, 
   all timestamps t1, t2, t3, and t4 are collected by the probes.
   All four timestamps are needed to measure two-way delay.</t>

	<t>
   Specifically, the probe response message is sent back on the incoming physical
   interface where the probe query message is received. This is required
   for example, in case of two-way measurement mode for Link delay.</t>

	<section title="Probe Response Message for SR-MPLS Policy" anchor="sect-4.2.2.1"><t>
   The message content for sending probe response message for two-way
   end-to-end performance measurement of an SR-MPLS Policy is shown in
   Figure 10.</t>

	<figure title="Example Probe Response Message for SR-MPLS Policy" anchor="ure-probe-response-message-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(1)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Segment(n)             | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                Message as shown in Figure 9                   |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	<t>
   The Path Segment Identifier (PSID) <xref target="I-D.ietf-spring-mpls-path-segment"/> of
   the forward SR Policy in the probe query can be used to find the
   associated reverse SR Policy <xref target="I-D.ietf-pce-sr-bidir-path"/> to send the probe
   response message for two-way measurement of SR Policy unless when using STAMP message with Return
   Path TLV.</t>

	</section>

	<section title="Probe Response Message for SRv6 Policy" anchor="sect-4.2.2.2"><t>
   The message content for sending probe response message on the
   congruent path of the data traffic for two-way end-to-end performance
   measurement of an SRv6 Policy with SRH is shown in Figure 11.</t>

	<figure title="Example Probe Response Message for SRv6 Policy" anchor="ure-probe-response-message-for-srv6-policy"><artwork><![CDATA[
 +---------------------------------------------------------------+
 | IP Header                                                     |
 .  Source IP Address = Sender IPv6 Address                      .
 .  Destination IP Address = Next Hop IPv6 Address               .
 .                                                               .
 +---------------------------------------------------------------+
 | SRH as specified in RFC 8754                                  |
 .  <Segment List>                                               .
 .                                                               .
 +---------------------------------------------------------------+
 | IP Header (Optional)                                          |
 .  Source IP Address = Reflector IPv6 Address                   .
 .  Destination IP Address = Source IPv6 Address from Query      .
 .                                                               .
 +---------------------------------------------------------------+
 | UDP Header                                                    |
 .  Source Port = As chosen by Sender                            .
 .  Destination Port = User-configured Port                      .
 .                                                               .
 +---------------------------------------------------------------+
 | Payload = DM Message as specified in Section 4.3 of RFC 8762| |
 . Payload = LM Message as specified in Figure 12 or 13          .
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>

	</section>

	</section>

	<section title="Loss Measurement Response Message Formats for STAMP" anchor="sect-4.2.4"><t>
   In this document, STAMP probe response message formats are defined for loss
   measurement as shown in Figure 12 and Figure 13.</t>

	<figure title="STAMP LM Probe Response Message - Unauthenticated Mode" anchor="ure-lm-probe-response-message-format"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Transmit Counter                       |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  | Block Number  | SSID                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Receive Counter                        |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sender Sequence Number                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sender Counter                         |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  |Sender Block Nu| MBZ           |Re Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Sender TTL   |      MBZ                                      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>

	<figure title="STAMP LM Probe Response Message - Authenticated Mode" anchor="ure-lm-probe-response-message-format-authenticated-mode"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (12 octets)                        |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Transmit Counter                       |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  | Block Number  | SSID                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (4 octets)                         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Receive Counter                        |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (8 octets)                         |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sender Sequence Number                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (12 octets)                        |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sender Counter                         |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |X|B| Reserved  |Sender Block Nu| MBZ           |Re Control Code|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        MBZ (4 octets)                         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Sender TTL   |                                               |
 +-+-+-+-+-+-+-+-+                                               |
 |                        MBZ (15 octets)                        |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 |                        HMAC (16 octets)                       |
 |                                                               |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>


        </section>
        </section>

	<section title="Node Address TLV for STAMP Message" anchor="sect-4.3">

        <t>In this document, Node Address TLV is defined for STAMP message <xref target="I-D.ietf-ippm-stamp-option-tlv"/> 
        and has the following format shown in Figure 14:</t>


	<figure title="Node Address TLV Format" anchor="ure-node-address-tlv-format"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Type                          | Length                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Reserved                      | Address Family                |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                           Address                             ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>

   <t>The Address Family field indicates the type of the address, and it
   SHALL be set to one of the assigned values in the "IANA Address Family Numbers" registry.</t>

   <t>The following Type is defined and it contains Node Address TLV:</t>

   <t>Destination Node Address (value TBA1):</t>
   <t>
   The Destination Node Address TLV is optional.  The Destination Node
   Address TLV indicates the address of the intended recipient node of the
   probe message.  The reflector node MUST NOT send response if it
   is not the intended destination node of the probe query message.
   This check is useful for example, for performance measurement of SR
   Policy when using the destination address in 127/8 range for IPv4 or
   in ::FFFF:127/104 range for IPv6.</t>

	</section>

	<section title="Return Path TLV for STAMP Message" anchor="sect-4.4"><t>
   For two-way performance measurement, the reflector node needs to send
   the probe response message on a specific reverse path.  The sender
   node can request in the probe query message to the reflector node to
   send a response back on a given reverse path (e.g. co-routed
   bidirectional path).  This way the destination node does not require
   any additional SR Policy state.</t>

	<t>
   For one-way performance measurement, the sender node address may not
   be reachable via IP route from the reflector node.  The sender node
   in this case needs to send its reachability path information to the
   reflector node.</t>

	<t>
   <xref target="I-D.ietf-ippm-stamp-option-tlv"/> defines STAMP probe query messages that
   can include one or more optional TLVs.  The TLV Type (value TBA2) is
   defined in this document for Return Path that carries reverse path for STAMP
   probe response messages (in the payload of the message).  The format
   of the Return Path TLV is shown in Figure 15:</t>

	<figure title="Return Path TLV" anchor="ure-return-path-tlv"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Type = TBA2                   | Length                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Return Path Sub-TLVs                       |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>
	<t>The following Type defined for the Return Path TLV contains the Node Address sub-TLV using the format shown in Figure 14:</t>

	<t><list style="symbols"><t>Type (value 0): Return Address. Target node address of the
      response different than the Source Address in the query</t>

	</list>
	</t>

	<figure title="Segment List Sub-TLV in Return Path TLV" anchor="ure-segment-list-sub-tlv-in-return-path-tlv"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Type                          | Length                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Segment(1)                                 |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 .                                                               .
 .                                                               .
 .                                                               .

 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Segment(n)                                 |
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
]]></artwork>
	</figure>
	<t>
   The Segment List Sub-TLV (shown in Figure 16) in the Return Path TLV can be one of the following Types:</t>

	<t><list style="symbols"><t>Type (value 1): SR-MPLS Label Stack of the Reverse SR Path</t>

	<t>Type (value 2): SR-MPLS Binding SID <xref target="I-D.ietf-pce-binding-label-sid"/> of
      the Reverse SR Policy</t>

	<t>Type (value 3): SRv6 Segment List of the Reverse SR Path</t>

	<t>Type (value 4): SRv6 Binding SID <xref target="I-D.ietf-pce-binding-label-sid"/> of
      the Reverse SR Policy</t>

	</list>
	</t>

	<t>
   The Return Path TLV is optional. The PM sender node MUST only insert
   one Return Path TLV in the probe query message and the reflector node
   MUST only process the first Return Path TLV in the probe query
   message and ignore other Return Path TLVs if present. The reflector
   node MUST send probe response message back on the reverse path
   specified in the Return Path TLV and MUST NOT add Return Path TLV in
   the probe response message.</t>

	</section>

	</section>

	<section title="Performance Measurement for P2MP SR Policies" anchor="sect-5">
	<t>
   The procedures for delay and loss measurement described in this
   document for Point-to-Point (P2P) SR Policies <xref target="I-D.ietf-spring-segment-routing-policy"/> 
   are also equally applicable to the Point-to-Multipoint (P2MP) SR Policies as following:</t>

	<t><list style="symbols"><t>The sender root node sends probe query messages using the
   Replication Segment defined in <xref target="I-D.voyer-spring-sr-replication-segment"/> for the
   P2MP SR Policy as shown in Figure 17.</t>

	<t>Each reflector leaf node sends its IP address in the Source
   Address of the probe response messages as shown in Figure 9.  This
   allows the sender root node to identify the reflector leaf nodes
   of the P2MP SR Policy.</t>

	<t>The P2MP root node measures the end-to-end delay and loss
   performance for each P2MP leaf node of the P2MP SR Policy.</t>

	</list>
	</t>

	<figure title="Example Query with Replication Segment for SR-MPLS Policy" anchor="ure-with-replication-segment-for-sr-mpls-policy"><artwork><![CDATA[
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |              Replication SID          | TC  |S|      TTL      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Message as shown in Figure 2 for DM or Figure 3 for LM      |
 .                                                               .
 +---------------------------------------------------------------+
]]></artwork>
	</figure>
	</section>

	<section title="ECMP Support for SR Policies" anchor="sect-6"><t>
   An SR Policy can have ECMPs between the source and transit nodes,
   between transit nodes and between transit and destination nodes.
   Usage of Anycast SID <xref target="RFC8402"/> by an SR Policy can result in ECMP
   paths via transit nodes part of that Anycast group.  The PM probe
   messages need to be sent to traverse different ECMP paths to measure
   performance delay of an SR Policy.</t>

	<t>
   Forwarding plane has various hashing functions available to forward
   packets on specific ECMP paths.  The mechanisms described in
   <xref target="RFC8029"/> and <xref target="RFC5884"/> for 
   handling ECMPs are also applicable to the
   performance measurement.  In IPv4 header of the PM probe messages,
   sweeping of Destination Address in 127/8 range can be used to exercise
   particular ECMP paths.  As specified in <xref target="RFC6437"/>, Flow Label field in
   the outer IPv6 header can also be used for sweeping.</t>

	<t>
   The considerations for performance loss measurement for different
   ECMP paths of an SR Policy are outside the scope of this document.</t>

	</section>

	<section title="Additional Message Processing Rules" anchor="sect-7"><t>
   The processing rules defined in this section are applicable to the
   STAMP messages for delay and loss measurement for Links and end-to-end SR Paths including SR Policies.</t>		
		
        <section title="TTL and Hop Limit" anchor="sect-7.1"><t>
   The TTL field in the IPv4 and MPLS headers of the
   probe query messages is set to 255 <xref target="RFC8762"/>.
   Similarly, the Hop Limit field in the IPv6 and SRH headers of the
   probe query messages is set to 255 <xref target="RFC8762"/>.</t>

	<t>
   When using the Destination IPv4 Address from the 127/8 range, the TTL
   in the IPv4 header is set to 1 <xref target="RFC8029"/>.  Similarly, when using the
   Destination IPv6 Address from the ::FFFF:127/104 range, the
   Hop Limit field in the inner IPv6 header is set to 1 whereas in the
   outer IPv6 header is set to 255.</t>

       <t> 
   For Link performance delay and loss measurements, 
   the TTL and Hop Limit field in the probe message is set to 1 in both one-way and two-way measurement modes. 
       </t>

	</section>

	<section title="Router Alert Option" anchor="sect-7.2"><t>
   The Router Alert IP option is not set when using the routable
   Destination IP Address in the probe messages.</t>

	<t>
   When using the Destination IPv4 Address from the 127/8 range, to be
   able to punt probe packets on the reflector node, the Router Alert IP
   Option of value 0x0 <xref target="RFC2113"/> for IPv4 MAY be added <xref target="RFC8029"/>.
   Similarly, when using the Destination IPv6 Address from the
   ::FFFF:127/104 range, the Router Alert IP Option of value 69
   <xref target="RFC7506"/> for IPv6 MAY be added in the destination option header, 
   Section 4.6 of <xref target="RFC8200"/>.  For SRv6
   Policy using SRH, it is added after the inner IPv6 header.</t>

	</section>

	<section title="UDP Checksum" anchor="sect-7.3"><t>
   The UDP Checksum Complement for delay and loss measurement messages
   follows the procedure defined in <xref target="RFC7820"/> and can be optionally used
   with the procedures defined in this document.</t>

	<t>
   For IPv4 and IPv6 probe messages, where the hardware is not capable
   of re-computing the UDP checksum or adding checksum complement
   <xref target="RFC7820"/>, the sender node sets the UDP checksum to 0 <xref target="RFC6936"/>
   <xref target="RFC8085"/>.  The receiving node bypasses the checksum validation and
   accepts the packets with UDP checksum value 0 for the UDP port being
   used for PM delay and loss measurements.</t>

	</section>

	</section>

	<section title="Security Considerations" anchor="sect-8"><t>
   The performance measurement is intended for deployment in
   well-managed private and service provider networks.  As such, it
   assumes that a node involved in a measurement operation has
   previously verified the integrity of the path and the identity of the
   far-end reflector node.</t>

	<t>
   If desired, attacks can be mitigated by performing basic validation
   and sanity checks, at the sender, of the counter or timestamp fields
   in received measurement response messages.  The minimal state
   associated with these protocols also limits the extent of measurement
   disruption that can be caused by a corrupt or invalid message to a
   single query/response cycle.</t>

	<t>
   Use of HMAC-SHA-256 in the authenticated mode protects the data
   integrity of the probe messages.  SRv6 has HMAC protection
   authentication defined for SRH <xref target="RFC8754"/>.
   Hence, PM probe messages for SRv6 may not need authentication mode.
   Cryptographic measures may be enhanced by the correct configuration
   of access-control lists and firewalls.</t>

	</section>

	<section title="IANA Considerations" anchor="sect-9"><t>
   IANA will create a "STAMP TLV Type" registry for <xref target="I-D.ietf-ippm-stamp-option-tlv"/>. 
   IANA is requested to allocate a value for the following mandatory
   Destination Address TLV Type from this registry. This TLV is to be
   carried in PM probe messages.</t>

	<t><list style="symbols"><t>Type TBA1: Destination Node Address TLV</t>

	</list>
	</t>

   <t>
   IANA is also requested to allocate a value for the following mandatory
   Return Path TLV Type from the same registry. This TLV is to be carried in
   PM probe query messages.</t>

	<t><list style="symbols"><t>Type TBA2: Return Path TLV</t>

	</list>
	</t>

   <t>
   IANA is requested to create a sub-registry for "Return Path Sub-TLV Type".
   All code points in the range 1 through 32759 in this registry shall be
   allocated according to the "IETF Review" procedure as specified in
   [RFC8126].  Code points in the range 32760 through 65279 in this
   registry shall be allocated according to the "First Come First
   Served" procedure as specified in [RFC8126]. Remaining code points are allocated according to <xref target="iana-return-path-tbl"/>:
   </t>

     <texttable anchor="iana-return-path-tbl" title="Return Path Sub-TLV Type Registry">
    <ttcol align="left">Value</ttcol>
    <ttcol align="center">Description</ttcol>
    <ttcol align="left">Reference</ttcol>
     <c>0- 32767</c>
    <c>Mandatory TLV, unassigned</c>
    <c>IETF Review</c>
     <c>32768 - 65279</c>
    <c>Optional TLV, unassigned</c>
    <c>First Come First Served</c>
     <c>65280 - 65519</c>
    <c>Experimental</c>
    <c>This document</c>
     <c>65520 - 65534</c>
    <c>Private Use</c>
    <c>This document</c>
         <c>65535</c>
    <c>Reserved</c>
    <c>This document</c>
   </texttable> 

 
   <t>
   IANA is requested to allocate the values for the following Sub-TLV Types from this registry.</t>

	<t><list style="symbols"><t>Type (value 0): Return Address</t>

	<t>Type (value 1): SR-MPLS Label Stack of the Reverse SR Path</t>

	<t>Type (value 2): SR-MPLS Binding SID <xref target="I-D.ietf-pce-binding-label-sid"/>
                         of the Reverse SR Policy</t>

	<t>Type (value 3): SRv6 Segment List of the Reverse SR Path</t>

	<t>Type (value 4): SRv6 Binding SID <xref target="I-D.ietf-pce-binding-label-sid"/> of
                         the Reverse SR Policy</t>

	</list>
	</t>


	</section>

	</middle>

	<back>
	<references title="Normative References">
	&RFC0768;
	&RFC2119;
	&RFC8174;
	&RFC8762;
	&I-D.ietf-6man-spring-srv6-oam;
	&I-D.ietf-ippm-stamp-option-tlv;
	</references>
	<references title="Informative References">
	<reference anchor="IEEE1588"><front>
	<title>1588-2008 IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems</title>
	<author>
	<organization>IEEE</organization>
	</author>

	<date month="March" year="2008"/>
	</front>

	</reference>
	&RFC2104;
	&RFC2113;
	&RFC4868;
	&RFC5884;
	&RFC6335;
	&RFC6437;
	&RFC6936;
	&RFC7506;
	&RFC7820;
	&RFC8029;
	&RFC8085;
	&RFC8186;
	&RFC8200;
	&RFC8321;
	&RFC8402;
	&RFC8754;
	&I-D.ietf-spring-segment-routing-policy;
	&I-D.voyer-spring-sr-replication-segment;
	&I-D.ietf-spring-mpls-path-segment;
	&I-D.ietf-spring-srv6-network-programming;
	&I-D.ietf-pce-binding-label-sid;
	&I-D.gandhi-mpls-ioam-sr;
	&I-D.ali-spring-ioam-srv6;
	&I-D.ietf-pce-sr-bidir-path;
	</references>
	<section title="Acknowledgments" numbered="no" anchor="acknowledgments"><t>
   The authors would like to thank Thierry Couture for the discussions
   on the use-cases for Performance Measurement in Segment Routing.  The authors
   would also like to thank Greg Mirsky for reviewing this document and
   providing useful comments and suggestions.  Patrick Khordoc and Radu
   Valceanu, both from Cisco Systems have helped significantly improve
   the mechanisms defined in this document.  The authors would like to
   acknowledge the earlier work on the loss measurement using TWAMP
   described in draft-xiao-ippm-twamp-ext-direct-loss.  The authors
   would also like to thank Sam Aldrin for the discussions to check for
   broken path.</t>

	</section>

	</back>

	</rfc>
